<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Traveller Starship Operations</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">
    <!-- Login Screen (GM or Player) -->
    <div id="login-screen" class="screen active">
      <div class="login-container">
        <h1 class="title">Traveller VTT for Starship Operations</h1>
        <p class="subtitle">Virtual Tabletop for Mongoose Traveller 2E</p>
        <p class="version-info">Version 0.31</p>

        <div class="login-options">
          <button id="btn-gm-login" class="btn btn-primary btn-large" title="Game Master login - Full campaign control and access to all ship data">
            GM Login
          </button>
          <button id="btn-player-login" class="btn btn-secondary btn-large" title="Player login - Join a campaign as crew member. Requires campaign code from GM.">
            Player Login
          </button>
        </div>

        <div id="campaign-select" class="hidden">
          <h2>Select Campaign</h2>
          <div id="campaign-list" class="campaign-list">
            <!-- Populated dynamically -->
          </div>
          <div class="campaign-buttons">
            <button id="btn-create-campaign" class="btn btn-success" title="Create a new campaign - You'll be the Game Master">
              + Create New Campaign
            </button>
            <button id="btn-import-campaign" class="btn btn-secondary" title="Import campaign from JSON file">
              Import Campaign
            </button>
            <input type="file" id="import-file-input" accept=".json" style="display: none;">
          </div>
          <button id="btn-back-login" class="btn btn-link">Back</button>
        </div>

        <div id="player-select" class="hidden">
          <h2>Join Campaign</h2>
          <div class="form-group">
            <label for="campaign-code">Campaign Code:</label>
            <input type="text" id="campaign-code" placeholder="Enter campaign code">
          </div>
          <div class="join-options">
            <button id="btn-join-campaign" class="btn btn-primary" title="Join with a reserved player slot - Your character data is saved">Join as Player</button>
            <button id="btn-join-guest" class="btn btn-secondary" title="Quick join - No permanent character, skill 0 in all roles">Join as Guest</button>
          </div>
          <p class="guest-info">Guests can take any role with skill 0. GM can override skill level.</p>
          <button id="btn-back-player" class="btn btn-link">Back</button>
        </div>

        <div id="guest-name-select" class="hidden">
          <h2>Guest Login</h2>
          <div class="form-group">
            <label for="guest-name">Your Name:</label>
            <input type="text" id="guest-name" placeholder="Enter your name">
          </div>
          <button id="btn-confirm-guest" class="btn btn-primary">Join as Guest</button>
          <button id="btn-back-guest" class="btn btn-link">Back</button>
        </div>

        <div id="player-slot-select" class="hidden">
          <h2>Select Your Slot</h2>
          <div id="player-slot-list" class="slot-list">
            <!-- Populated dynamically -->
          </div>
          <button id="btn-back-player-slot" class="btn btn-link">Back</button>
        </div>
      </div>
    </div>

    <!-- GM Setup Screen -->
    <div id="gm-setup-screen" class="screen">
      <header class="header">
        <h1 id="gm-campaign-name">Campaign Setup</h1>
        <div class="header-actions">
          <button id="btn-gm-settings" class="btn btn-icon" title="Settings">‚öô</button>
          <button id="btn-gm-logout" class="btn btn-link">Logout</button>
        </div>
      </header>

      <div class="gm-setup-container">
        <!-- Campaign Code Section -->
        <section class="setup-section campaign-code-section">
          <h2>Campaign Code</h2>
          <div class="campaign-code-display">
            <code id="campaign-code-value">--------</code>
            <button id="btn-copy-code" class="btn btn-small" title="Copy to clipboard">Copy</button>
          </div>
          <p class="code-hint">Share this code with players to join</p>
        </section>

        <section class="setup-section">
          <h2>Player Slots</h2>
          <div id="gm-player-slots" class="player-slots">
            <!-- Populated dynamically -->
          </div>
          <div class="add-slot-form">
            <input type="text" id="new-slot-name" placeholder="Player name">
            <button id="btn-add-player-slot" class="btn btn-success" title="Reserve a player slot - Players join with this name">+ Add Slot</button>
          </div>
        </section>

        <section class="setup-section">
          <h2>Ships</h2>
          <div id="gm-ships-list" class="ships-list">
            <!-- Populated dynamically -->
          </div>
          <div class="button-row">
            <button id="btn-add-ship" class="btn btn-success" title="Add a ship to campaign - Select from templates">+ Add Ship</button>
            <button id="btn-custom-ship" class="btn btn-secondary" title="Create a custom ship with full editor">+ Custom Ship</button>
          </div>
        </section>

        <section class="setup-section">
          <h2>Campaign Settings</h2>
          <div class="form-group" title="Imperial calendar date - Format: DDD-YYYY (day 001-365, year 1105+)">
            <label>Current Date:</label>
            <input type="text" id="campaign-date" placeholder="1105-001">
          </div>
          <div class="form-group" title="Current star system - Location for sensor contacts and navigation">
            <label>Current System:</label>
            <input type="text" id="campaign-system" placeholder="Regina">
          </div>
          <div class="form-group" title="God Mode - Direct editing of ship stats, contacts, and systems. Bypass normal game rules.">
            <label>
              <input type="checkbox" id="god-mode-toggle">
              God Mode (Full Control)
            </label>
          </div>
        </section>

        <div class="setup-actions">
          <button id="btn-start-session" class="btn btn-primary btn-large" title="Launch bridge view - Players can then join their stations">
            Start Session
          </button>
        </div>
      </div>
    </div>

    <!-- Player Setup Screen (Character/Role Selection) -->
    <div id="player-setup-screen" class="screen">
      <header class="header">
        <h1 id="player-slot-name">Player Setup</h1>
        <button id="btn-player-logout" class="btn btn-link">Logout</button>
      </header>

      <div class="player-setup-container">
        <section class="setup-section">
          <h2>Your Character</h2>
          <div id="character-display" class="character-card">
            <p class="placeholder">No character imported</p>
          </div>
          <div class="character-actions">
            <button id="btn-import-character" class="btn btn-secondary" title="Import character from JSON, text, or paste from character sheet">Import Character</button>
            <button id="btn-quick-character" class="btn btn-link" title="Create a basic character with default skills">Quick Create</button>
          </div>
        </section>

        <section class="setup-section">
          <h2>Select Ship</h2>
          <div id="ship-select-list" class="ship-select-list">
            <!-- Populated dynamically -->
          </div>
        </section>

        <section class="setup-section">
          <h2>Select Crew Role</h2>
          <div id="role-select-list" class="role-select-list">
            <!-- Populated dynamically -->
          </div>
        </section>

        <div class="setup-actions">
          <button id="btn-join-bridge" class="btn btn-primary btn-large" disabled title="Select a role and join the bridge crew">
            Join Bridge
          </button>
        </div>
      </div>
    </div>

    <!-- Bridge View (Main Operations Screen) -->
    <div id="bridge-screen" class="screen">
      <header class="bridge-header">
        <div class="ship-info">
          <h1 id="bridge-ship-name">Ship Name</h1>
          <span id="bridge-campaign-name" class="campaign-display"></span>
          <span class="header-separator">¬∑</span>
          <span id="bridge-date" class="date-display">1105-001 12:00</span>
          <span class="header-separator">¬∑</span>
          <span id="bridge-location" class="location-display">System</span>
        </div>
        <div id="guest-indicator" class="guest-indicator hidden">
          <span class="guest-badge">GUEST</span>
        </div>
        <div id="alert-status" class="alert-status normal">
          <span class="alert-indicator"></span>
          <span class="alert-text">NORMAL</span>
        </div>
        <div id="weapons-auth-indicator" class="weapons-auth-indicator hold" title="Weapons Authorization Status">
          <span class="weapons-text">WEAPONS HOLD</span>
        </div>
        <div class="bridge-user-info">
          <span id="bridge-user-name" class="user-name">User</span>
          <span class="user-role-badge" id="bridge-user-role">Role</span>
          <button id="btn-change-role" class="btn btn-small btn-change-role" title="Change Role">Change</button>
          <span class="user-ship-badge" id="bridge-user-ship">Ship</span>
        </div>
        <div class="header-actions">
          <button id="btn-ship-systems" class="btn btn-icon ship-systems-btn" title="Ship Systems Status">
            <span class="ship-systems-icon">‚öô</span>
            <span class="ship-systems-indicator all-green"></span>
          </button>
          <button id="btn-fullscreen" class="btn btn-icon" title="Toggle Fullscreen (F)">‚õ∂</button>
          <button id="btn-bridge-menu" class="btn btn-icon" title="Menu">‚ò∞</button>
          <button id="btn-bridge-logout" class="btn btn-link">Logout</button>
        </div>
      </header>

      <!-- Ship Systems Panel (hidden by default) -->
      <div id="ship-systems-panel" class="ship-systems-panel hidden">
        <div class="ship-systems-header">
          <h3>Ship Systems Status</h3>
          <button id="btn-close-ship-systems" class="btn btn-icon btn-close">√ó</button>
        </div>
        <div class="ship-systems-grid">
          <div class="system-item" data-system="mDrive">
            <span class="system-status-dot"></span>
            <span class="system-name">M-Drive</span>
            <span class="system-status-text">Operational</span>
          </div>
          <div class="system-item" data-system="jDrive">
            <span class="system-status-dot"></span>
            <span class="system-name">J-Drive</span>
            <span class="system-status-text">Operational</span>
          </div>
          <div class="system-item" data-system="powerPlant">
            <span class="system-status-dot"></span>
            <span class="system-name">Power Plant</span>
            <span class="system-status-text">Operational</span>
          </div>
          <div class="system-item" data-system="sensors">
            <span class="system-status-dot"></span>
            <span class="system-name">Sensors</span>
            <span class="system-status-text">Operational</span>
          </div>
          <div class="system-item" data-system="computer">
            <span class="system-status-dot"></span>
            <span class="system-name">Computer</span>
            <span class="system-status-text">Operational</span>
          </div>
          <div class="system-item" data-system="weapon">
            <span class="system-status-dot"></span>
            <span class="system-name">Weapons</span>
            <span class="system-status-text">Operational</span>
          </div>
          <div class="system-item" data-system="hull">
            <span class="system-status-dot"></span>
            <span class="system-name">Hull</span>
            <span class="system-status-text">Operational</span>
          </div>
          <div class="system-item" data-system="armour">
            <span class="system-status-dot"></span>
            <span class="system-name">Armour</span>
            <span class="system-status-text">Operational</span>
          </div>
          <div class="system-item" data-system="fuel">
            <span class="system-status-dot"></span>
            <span class="system-name">Fuel System</span>
            <span class="system-status-text">Operational</span>
          </div>
          <div class="system-item" data-system="cargo">
            <span class="system-status-dot"></span>
            <span class="system-name">Cargo</span>
            <span class="system-status-text">Operational</span>
          </div>
          <div class="system-item" data-system="crew">
            <span class="system-status-dot"></span>
            <span class="system-name">Life Support</span>
            <span class="system-status-text">Operational</span>
          </div>
        </div>
      </div>

      <!-- Ship Status Bar -->
      <section id="ship-status-bar" class="ship-status-bar">
        <div class="status-item" title="Hull Points - Ship structural integrity. At 0 HP the ship is disabled.">
          <span class="status-label">Hull</span>
          <div class="status-bar-container">
            <div id="hull-bar" class="status-bar hull-bar" style="width: 100%"></div>
          </div>
          <span id="hull-value" class="status-value">100%</span>
        </div>
        <div class="status-item" title="Fuel (tons) - Jump fuel + maneuver fuel. Jump-2 requires 20 tons per jump.">
          <span class="status-label">Fuel</span>
          <div class="status-bar-container">
            <div id="fuel-bar" class="status-bar fuel-bar" style="width: 100%"></div>
          </div>
          <span id="fuel-value" class="status-value">40/40</span>
        </div>
        <div class="status-item" title="Power Plant Output - Available power for ship systems. Below 50% some systems may fail.">
          <span class="status-label">Power</span>
          <div class="status-bar-container">
            <div id="power-bar" class="status-bar power-bar" style="width: 100%"></div>
          </div>
          <span id="power-value" class="status-value">100%</span>
        </div>
        <div class="status-item location-item" title="Current position - Star system, in-system location, and ship status">
          <span class="status-label">Location</span>
          <span id="location-value" class="status-value location-value">Regina System</span>
        </div>
      </section>

      <main class="bridge-main">
        <!-- Sensor Display (Top) -->
        <section id="sensor-display" class="sensor-panel" title="Sensor contacts - Click on a contact for details">
          <div class="panel-header">
            <h2>Sensor Display</h2>
            <div class="sensor-controls">
              <select id="contact-sort" class="contact-sort-select" title="Sort contacts">
                <option value="range">Range</option>
                <option value="name">Name</option>
                <option value="type">Type</option>
              </select>
              <select id="contact-filter" class="contact-filter-select" title="Filter contacts">
                <option value="all">All</option>
                <option value="ships">Ships</option>
                <option value="stations">Stations</option>
                <option value="celestial">Celestial</option>
                <option value="hostiles">Hostiles</option>
              </select>
            </div>
            <span id="sensor-status" class="status-indicator" title="PASSIVE: Detecting emissions. ACTIVE: Emitting pulses (detectable). DEEP SCAN: Detailed analysis.">PASSIVE</span>
            <button class="btn btn-icon btn-panel-expand" data-panel="sensor-display" title="Expand panel [1]">‚õ∂</button>
          </div>
          <div id="sensor-contacts" class="contacts-list">
            <p class="placeholder">No contacts detected</p>
          </div>
        </section>

        <!-- Role Panel (Bottom Left) - Changes based on role -->
        <section id="role-panel" class="role-panel" title="Your bridge station - Actions available depend on your role">
          <div class="panel-header">
            <h2 id="role-panel-title">Your Role</h2>
            <span id="role-name" class="role-indicator" title="Current duty station. Click Change Role button to switch roles.">Pilot</span>
            <span id="role-quirk-display" class="role-quirk-display" title="Your station quirk"></span>
            <button id="btn-edit-role-personality" class="btn btn-small btn-secondary" title="Customize your title and quirk">Edit</button>
            <button id="btn-leave-role" class="btn btn-small btn-warning" title="Go off-duty - NPC will take over your station">Leave</button>
            <div class="panel-expand-controls">
              <button id="btn-expand-half" class="btn btn-icon btn-expand" title="Expand to half screen (claims sensor area)">‚¨Ü</button>
              <button id="btn-expand-full" class="btn btn-icon btn-expand" title="Expand to full screen [F]">‚õ∂</button>
              <button id="btn-collapse-panel" class="btn btn-icon btn-expand hidden" title="Collapse panel [Esc]">‚úï</button>
            </div>
          </div>
          <div id="role-actions" class="role-actions">
            <!-- Populated based on role -->
          </div>
          <!-- Role-specific detail view (expandable) -->
          <div id="role-detail-view" class="role-detail hidden">
            <!-- Populated based on role -->
          </div>
          <div class="role-panel-footer">
            <button id="btn-toggle-detail" class="btn btn-link">Show Details ‚ñº</button>
            <a href="https://github.com/anthropics/claude-code/issues" target="_blank" class="feedback-link" title="Report bugs or request features - Fast turnaround!">Feedback</a>
          </div>
        </section>

        <!-- Crew Status (Bottom Center) -->
        <section id="crew-panel" class="crew-panel" title="Crew roster - Players and NPCs currently on duty">
          <div class="panel-header">
            <h2>Crew Status</h2>
            <button class="btn btn-icon btn-panel-expand" data-panel="crew-panel" title="Expand panel [3]">‚õ∂</button>
          </div>
          <div id="crew-list" class="crew-list">
            <!-- Populated dynamically -->
          </div>
        </section>

        <!-- Ship Log (Bottom Right) -->
        <section id="log-panel" class="log-panel" title="Ship's log - All events and notes are recorded here">
          <div class="panel-header">
            <h2>Ship Log</h2>
            <button id="btn-add-log" class="btn btn-small" title="Add a personal note to the ship's log">+ Add Note</button>
            <button id="btn-copy-log" class="btn btn-small btn-secondary" onclick="window.copyShipLog()" title="Copy ship log to clipboard">Copy</button>
            <button class="btn btn-icon btn-panel-expand" data-panel="log-panel" title="Expand panel [4]">‚õ∂</button>
          </div>
          <div id="ship-log" class="ship-log">
            <!-- Populated dynamically -->
          </div>
        </section>
      </main>

      <!-- GM Prep Panel (Collapsible Sidebar - Autorun 8) -->
      <aside id="gm-prep-panel" class="gm-prep-panel hidden">
        <div class="prep-panel-header">
          <h3>GM Prep</h3>
          <button id="btn-close-prep-panel" class="btn-close" title="Close prep panel">√ó</button>
        </div>
        <nav class="prep-tabs">
          <button class="prep-tab active" data-tab="reveals">Reveals</button>
          <button class="prep-tab" data-tab="npcs">NPCs</button>
          <button class="prep-tab" data-tab="locations">Locations</button>
          <button class="prep-tab" data-tab="events">Events</button>
          <button class="prep-tab" data-tab="email">Email</button>
          <button class="prep-tab" data-tab="handouts">Handouts</button>
          <button class="prep-tab" data-tab="contacts">Contacts</button>
        </nav>

        <!-- Reveals Tab -->
        <div id="prep-tab-reveals" class="prep-tab-content active">
          <div class="prep-list-header">
            <span class="prep-count" id="reveals-count">0 reveals</span>
            <button id="btn-add-reveal" class="btn btn-small btn-success">+ Add</button>
          </div>
          <div id="reveals-list" class="prep-list">
            <p class="placeholder">No reveals prepared</p>
          </div>
        </div>

        <!-- NPCs Tab -->
        <div id="prep-tab-npcs" class="prep-tab-content">
          <div class="prep-list-header">
            <span class="prep-count" id="npcs-count">0 NPCs</span>
            <button id="btn-add-npc" class="btn btn-small btn-success">+ Add</button>
          </div>
          <div id="npcs-list" class="prep-list">
            <p class="placeholder">No NPCs prepared</p>
          </div>
        </div>

        <!-- Locations Tab -->
        <div id="prep-tab-locations" class="prep-tab-content">
          <div class="prep-list-header">
            <span class="prep-count" id="locations-count">0 locations</span>
            <button id="btn-add-location" class="btn btn-small btn-success">+ Add</button>
          </div>
          <div id="locations-list" class="prep-list">
            <p class="placeholder">No locations prepared</p>
          </div>
        </div>

        <!-- Events Tab -->
        <div id="prep-tab-events" class="prep-tab-content">
          <div class="prep-list-header">
            <span class="prep-count" id="events-count">0 events</span>
            <button id="btn-add-event" class="btn btn-small btn-success">+ Add</button>
          </div>
          <div id="events-list" class="prep-list">
            <p class="placeholder">No events prepared</p>
          </div>
        </div>

        <!-- Email Tab -->
        <div id="prep-tab-email" class="prep-tab-content">
          <div class="prep-list-header">
            <span class="prep-count" id="email-count">0 emails</span>
            <button id="btn-add-email" class="btn btn-small btn-success">+ Draft</button>
          </div>
          <div id="email-list" class="prep-list">
            <p class="placeholder">No emails queued</p>
          </div>
        </div>

        <!-- Handouts Tab -->
        <div id="prep-tab-handouts" class="prep-tab-content">
          <div class="prep-list-header">
            <span class="prep-count" id="handouts-count">0 handouts</span>
            <button id="btn-add-handout" class="btn btn-small btn-success">+ Add</button>
          </div>
          <div id="handouts-list" class="prep-list">
            <p class="placeholder">No handouts prepared</p>
          </div>
        </div>

        <!-- Contacts Tab (Autorun 14) -->
        <div id="prep-tab-contacts" class="prep-tab-content">
          <div class="prep-list-header">
            <span class="prep-count" id="contacts-count">0 contacts</span>
            <button id="btn-add-combat-contact" class="btn btn-small btn-danger">+ Add Hostile</button>
          </div>
          <div id="combat-contacts-list" class="prep-list">
            <p class="placeholder">No combat contacts in sensor range</p>
          </div>
        </div>

        <!-- Import/Export Footer -->
        <div class="prep-panel-footer">
          <button id="btn-export-adventure" class="btn btn-small" title="Export adventure prep to JSON">Export</button>
          <button id="btn-import-adventure" class="btn btn-small" title="Import adventure prep from JSON">Import</button>
        </div>
      </aside>

      <!-- GM Prep Panel Toggle Button -->
      <button id="btn-toggle-prep-panel" class="btn-prep-toggle hidden" title="Open GM Prep Panel">
        Prep
      </button>

      <!-- GM Overlay (shown when GM is viewing) --><div id="gm-overlay" class="gm-overlay hidden">
        <!-- AR-DYNUI-1.0: Grouped footer controls -->
        <div class="gm-controls">
          <!-- Alert Status Controls -->
          <div class="gm-control-group">
            <span class="control-label">Alert:</span>
            <button id="btn-alert-normal" class="btn btn-alert btn-alert-normal" title="Normal operations - Standard watch, crew may be off-duty">NORMAL</button>
            <button id="btn-alert-yellow" class="btn btn-alert btn-alert-yellow" title="Yellow Alert - Potential danger, all crew to stations">YELLOW</button>
            <button id="btn-alert-red" class="btn btn-alert btn-alert-red" title="Red Alert - Combat imminent, battle stations!">RED</button>
          </div>
          <!-- Time & Log Group -->
          <div class="gm-control-group">
            <button id="btn-gm-advance-time" class="btn btn-small" title="Advance game time - Minutes, hours, days, or weeks">Advance Time</button>
            <button id="btn-gm-add-log" class="btn btn-small" title="Add entry to ship's log - Narrative events, system notes">Add Log</button>
          </div>
          <!-- Navigation Group -->
          <div class="gm-control-group">
            <button id="btn-gm-add-contact" class="btn btn-small" title="Create new sensor contact - Ships, asteroids, stations">Add Contact</button>
            <button id="btn-gm-lookup-system" class="btn btn-small" title="Search TravellerMap for system data - Set current location">Lookup System</button>
            <button id="btn-subsector-map" class="btn btn-small" onclick="toggleSubsectorMap()" title="View shared map of known space - Click system to navigate">Known Space</button>
          </div>
          <!-- Combat Group -->
          <div class="gm-control-group gm-control-group-combat">
            <button id="btn-gm-damage" class="btn btn-small btn-warning" title="Apply damage to ship systems - Selective or random">Damage</button>
            <button id="btn-gm-initiative" class="btn btn-small btn-warning" title="Roll initiative for all crew - Sets action order">Initiative</button>
            <button id="btn-gm-combat" class="btn btn-small btn-danger" title="Enter tactical combat mode - Full space combat system">Combat</button>
            <button id="btn-spawn-training" class="btn btn-small btn-success" title="Spawn training asteroid DRN at Short range">Training</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Combat Screen (Placeholder - to be integrated with existing) -->
    <div id="combat-screen" class="screen hidden">
      <header class="combat-header">
        <h1>COMBAT MODE</h1>
        <button id="btn-exit-combat" class="btn btn-secondary">Exit Combat</button>
      </header>
      <main id="combat-main">
        <!-- Combat UI will be loaded here -->
        <p class="placeholder">Combat system integration pending...</p>
      </main>
    </div>

    <!-- Contact Tooltip (TIP-1) -->
    <div id="contact-tooltip" class="contact-tooltip hidden">
      <div class="tooltip-header">
        <span id="tooltip-contact-name" class="tooltip-name">Contact</span>
        <button class="btn-close tooltip-close" id="btn-close-tooltip">√ó</button>
      </div>
      <div id="tooltip-content" class="tooltip-body">
        <!-- Populated dynamically -->
      </div>
    </div>

    <!-- Full-Screen Email App (Stage 13.4) -->
    <div id="email-app" class="email-app hidden">
      <header class="email-app-header">
        <h1>Ship Mail</h1>
        <span id="email-unread-count" class="email-unread-badge"></span>
        <div class="email-app-actions">
          <button id="btn-compose-email" class="btn btn-primary btn-small">Compose</button>
          <button id="btn-close-email-app" class="btn btn-icon" title="Close [Esc]">‚úï</button>
        </div>
      </header>
      <div class="email-app-body">
        <aside class="email-sidebar">
          <div id="email-inbox-list" class="email-inbox-list">
            <p class="placeholder">No messages</p>
          </div>
        </aside>
        <main class="email-content">
          <div id="email-message-view" class="email-message-view">
            <p class="placeholder">Select a message to read</p>
          </div>
          <div id="email-compose-view" class="email-compose-view hidden">
            <div class="compose-header">
              <span class="compose-to">To: <span id="compose-recipient"></span></span>
            </div>
            <input type="text" id="compose-subject-input" class="compose-subject" placeholder="Subject">
            <textarea id="compose-body-input" class="compose-body" placeholder="Write your message..."></textarea>
            <div class="compose-actions">
              <button id="btn-cancel-compose" class="btn btn-secondary">Cancel</button>
              <button id="btn-send-email" class="btn btn-primary">Send</button>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Hamburger Menu (Slide-out Panel) - Autorun 6 -->
    <div id="hamburger-menu-overlay" class="menu-overlay hidden"></div>
    <nav id="hamburger-menu" class="hamburger-menu">
      <div class="menu-header">
        <h3>Ship Operations</h3>
        <button id="btn-close-menu" class="btn-close">√ó</button>
      </div>
      <div class="menu-content">
        <div class="menu-section">
          <h4>Communications</h4>
          <button class="menu-item" data-feature="mail" id="menu-mail">
            <span class="menu-icon">üìß</span>
            <span class="menu-label">Ship Mail</span>
            <span class="mail-menu-badge hidden" id="mail-badge">0</span>
          </button>
          <button class="menu-item" data-feature="contacts">
            <span class="menu-icon">üë•</span>
            <span class="menu-label">NPC Contacts</span>
          </button>
          <button class="menu-item" onclick="showLibraryComputer()" data-feature="library">
            <span class="menu-icon">üìö</span>
            <span class="menu-label">Library Computer</span>
          </button>
        </div>
        <div class="menu-section">
          <h4>Ship Management</h4>
          <button class="menu-item" onclick="showShipConfiguration()" data-feature="ship-config">
            <span class="menu-icon">üîß</span>
            <span class="menu-label">Ship Configuration</span>
          </button>
          <button class="menu-item" data-feature="cargo">
            <span class="menu-icon">üì¶</span>
            <span class="menu-label">Cargo Manifest</span>
            <span class="menu-badge stub">Coming Soon</span>
          </button>
          <button class="menu-item" data-feature="finances">
            <span class="menu-icon">üí∞</span>
            <span class="menu-label">Ship Finances</span>
            <span class="menu-badge stub">Coming Soon</span>
          </button>
        </div>
        <div class="menu-section">
          <h4>Crew</h4>
          <button class="menu-item" onclick="showCrewRoster()" data-feature="crew-roster">
            <span class="menu-icon">üìã</span>
            <span class="menu-label">Crew Roster</span>
          </button>
          <button class="menu-item" data-feature="medical">
            <span class="menu-icon">üè•</span>
            <span class="menu-label">Medical Records</span>
            <span class="menu-badge stub">Coming Soon</span>
          </button>
        </div>
        <div class="menu-section">
          <h4>Navigation</h4>
          <button class="menu-item" data-feature="shared-map" id="menu-shared-map">
            <span class="menu-icon">üó∫Ô∏è</span>
            <span class="menu-label">Shared Map</span>
            <span class="menu-badge shared-map-badge hidden" id="shared-map-badge">LIVE</span>
          </button>
          <button class="menu-item" data-feature="system-map" id="menu-system-map">
            <span class="menu-icon">ü™ê</span>
            <span class="menu-label">Star System</span>
            <span class="menu-badge new">NEW</span>
          </button>
        </div>
        <div class="menu-section">
          <h4>Reference</h4>
          <button class="menu-item" data-feature="ship-log" id="menu-ship-log">
            <span class="menu-icon">üìú</span>
            <span class="menu-label">Ship Log</span>
          </button>
          <button class="menu-item" onclick="showLibraryComputer()" data-feature="library">
            <span class="menu-icon">üìö</span>
            <span class="menu-label">Ship's Library</span>
          </button>
        </div>
        <div class="menu-section menu-section-feedback">
          <h4>Feedback</h4>
          <button class="menu-item menu-item-feedback" data-feature="feedback">
            <span class="menu-icon">üí¨</span>
            <span class="menu-label">Report Bug / Request Feature</span>
          </button>
        </div>
      </div>
      <div class="menu-footer">
        <span class="version-info">Traveller VTT v0.6</span>
      </div>
    </nav>

    <!-- Modals -->
    <div id="modal-overlay" class="modal-overlay hidden">
      <div id="modal-content" class="modal-content">
        <!-- Modal content populated dynamically -->
      </div>
    </div>
  </div>

  <!-- Character Import Modal Template -->
  <template id="template-character-import">
    <div class="modal-header">
      <h2>Import Character</h2>
      <button class="btn-close" data-close-modal>√ó</button>
    </div>
    <div class="modal-body">
      <!-- File Upload Section (AR-19.3-4) -->
      <div class="form-group import-file-section">
        <div class="file-drop-zone" id="char-file-drop">
          <input type="file" id="char-file-input" accept=".json,.txt" hidden>
          <span class="drop-icon">üìÅ</span>
          <span class="drop-text">Drag & drop JSON file here or <label for="char-file-input" class="file-label">browse</label></span>
        </div>
      </div>

      <div class="import-divider-or">
        <span>OR</span>
      </div>

      <!-- Paste Import Section -->
      <div class="form-group import-paste-section">
        <label for="char-paste">Paste Character Text or JSON:</label>
        <textarea id="char-paste" rows="6" placeholder="Paste character sheet text here...
Example:
Marcus Cole
UPP: 789A87
Skills: Pilot-2, Gunnery-1, Vacc Suit-1"></textarea>
        <button class="btn btn-secondary" id="btn-parse-character">Parse</button>
        <div id="parse-status" class="parse-status"></div>
      </div>

      <hr class="import-divider">

      <!-- Manual Entry Section -->
      <div class="form-group">
        <label for="char-name">Character Name:</label>
        <input type="text" id="char-name" required>
      </div>
      <div class="form-group">
        <label>Skills (relevant to ship operations):</label>
        <div class="skill-inputs">
          <div class="skill-row" title="Pilot - Spacecraft maneuvering, evasion, docking. Used for Pilot role.">
            <label>Pilot:</label>
            <input type="number" id="skill-pilot" min="0" max="6" value="0">
          </div>
          <div class="skill-row" title="Astrogation - Jump route calculation, navigation. Used for Astrogator role.">
            <label>Astrogation:</label>
            <input type="number" id="skill-astrogation" min="0" max="6" value="0">
          </div>
          <div class="skill-row" title="Engineer - Power plant, drives, repairs. Used for Engineer and Damage Control roles.">
            <label>Engineer:</label>
            <input type="number" id="skill-engineer" min="0" max="6" value="0">
          </div>
          <div class="skill-row" title="Gunner - Turrets, batteries, missile systems. Used for Gunner role.">
            <label>Gunnery:</label>
            <input type="number" id="skill-gunnery" min="0" max="6" value="0">
          </div>
          <div class="skill-row" title="Electronics (Sensors) - Scanning, detection, jamming. Used for Sensors role.">
            <label>Sensors:</label>
            <input type="number" id="skill-sensors" min="0" max="6" value="0">
          </div>
          <div class="skill-row" title="Leadership - Command, crew management, morale. Used for Captain role.">
            <label>Leadership:</label>
            <input type="number" id="skill-leadership" min="0" max="6" value="0">
          </div>
          <div class="skill-row" title="Tactics (Naval) - Space combat strategy. Adds to Captain's Initiative roll.">
            <label>Tactics:</label>
            <input type="number" id="skill-tactics" min="0" max="6" value="0">
          </div>
        </div>
      </div>
      <div class="form-group">
        <label>Stats:</label>
        <div class="stat-inputs">
          <div class="stat-row" title="Dexterity - Physical coordination. DM for Pilot/Gunner checks. 7 = human average.">
            <label>DEX:</label>
            <input type="number" id="stat-dex" min="1" max="15" value="7">
          </div>
          <div class="stat-row" title="Intelligence - Mental quickness. DM for Sensors/Tactics checks. 7 = human average.">
            <label>INT:</label>
            <input type="number" id="stat-int" min="1" max="15" value="7">
          </div>
          <div class="stat-row" title="Education - Technical knowledge. DM for Astrogation/Engineering. 7 = human average.">
            <label>EDU:</label>
            <input type="number" id="stat-edu" min="1" max="15" value="7">
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button class="btn btn-primary" id="btn-save-character">Save Character</button>
    </div>
  </template>

  <!-- Create Campaign Modal Template -->
  <template id="template-create-campaign">
    <div class="modal-header">
      <h2>Create New Campaign</h2>
      <button class="btn-close" data-close-modal>√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="new-campaign-name">Campaign Name:</label>
        <input type="text" id="new-campaign-name" placeholder="Spinward Marches Campaign" required>
      </div>
      <div class="form-group">
        <label for="gm-name">Your Name (GM):</label>
        <input type="text" id="gm-name" placeholder="Bruce" required>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button class="btn btn-primary" id="btn-confirm-create-campaign">Create Campaign</button>
    </div>
  </template>

  <!-- Time Advance Modal Template -->
  <template id="template-time-advance">
    <div class="modal-header">
      <h2>Advance Time</h2>
      <button class="btn-close" data-close-modal>√ó</button>
    </div>
    <div class="modal-body">
      <div class="time-quick-buttons">
        <button class="btn btn-secondary time-quick" data-minutes="10">+10 min</button>
        <button class="btn btn-secondary time-quick" data-minutes="30">+30 min</button>
        <button class="btn btn-secondary time-quick" data-hours="1">+1 hour</button>
        <button class="btn btn-secondary time-quick" data-hours="4">+4 hours</button>
        <button class="btn btn-secondary time-quick" data-hours="8">+8 hours</button>
        <button class="btn btn-secondary time-quick" data-hours="24">+1 day</button>
        <button class="btn btn-secondary time-quick time-jump" data-hours="168" title="Jump space transit (7 days)">+7 days</button>
        <button class="btn btn-secondary time-quick time-jump" data-hours="240" title="Extended jump (10 days)">+10 days</button>
      </div>
      <div class="time-custom">
        <h4>Custom Time</h4>
        <div class="time-custom-inputs">
          <div class="form-group inline">
            <input type="number" id="custom-hours" min="0" max="999" value="0">
            <label>hours</label>
          </div>
          <div class="form-group inline">
            <input type="number" id="custom-minutes" min="0" max="59" value="0">
            <label>minutes</label>
          </div>
        </div>
        <button class="btn btn-primary" id="btn-custom-time">Advance</button>
      </div>
    </div>
  </template>

  <!-- Add Log Entry Modal Template -->
  <template id="template-add-log">
    <div class="modal-header">
      <h2>Add Ship Log Entry</h2>
      <button class="btn-close" data-close-modal>√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="log-entry-type">Entry Type</label>
        <select id="log-entry-type">
          <option value="status">Status Update</option>
          <option value="captain">Captain's Log</option>
          <option value="engineering">Engineering</option>
          <option value="combat">Combat Report</option>
          <option value="arrival">Arrival/Departure</option>
          <option value="jump">Jump Event</option>
          <option value="note">GM Note</option>
        </select>
      </div>
      <div class="form-group">
        <label for="log-entry-message">Message</label>
        <textarea id="log-entry-message" rows="3" placeholder="Log entry message..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button class="btn btn-primary" id="btn-save-log-entry">Add Entry</button>
    </div>
  </template>

  <!-- AR-33: Travel Confirmation Modal -->
  <template id="template-travel-confirm">
    <div class="modal-header">
      <h2>Travel to <span id="travel-destination-name">System</span>?</h2>
      <button class="btn-close" data-close-modal>√ó</button>
    </div>
    <div class="modal-body">
      <div class="travel-options">
        <label class="travel-option">
          <input type="radio" name="travel-time" value="instant" id="travel-instant">
          <span class="travel-label">Instant (no time passes)</span>
          <small>GM teleport - useful for session setup</small>
        </label>
        <label class="travel-option">
          <input type="radio" name="travel-time" value="7" id="travel-7d" checked>
          <span class="travel-label">Standard jump (7 days)</span>
          <small>Normal jump space transit time</small>
        </label>
        <label class="travel-option">
          <input type="radio" name="travel-time" value="10" id="travel-10d">
          <span class="travel-label">Extended jump (10 days)</span>
          <small>Misjump or multiple jumps</small>
        </label>
        <label class="travel-option">
          <input type="radio" name="travel-time" value="custom" id="travel-custom">
          <span class="travel-label">Custom time:</span>
          <input type="number" id="travel-custom-days" min="0" max="365" value="7" style="width: 60px;"> days
        </label>
      </div>
      <div class="travel-summary">
        <div class="summary-row">
          <span>Current date:</span>
          <span id="travel-current-date">--</span>
        </div>
        <div class="summary-row">
          <span>Arrival date:</span>
          <span id="travel-arrival-date">--</span>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button class="btn btn-primary" id="btn-confirm-travel">Travel</button>
    </div>
  </template>

  <!-- Add Contact Modal Template -->
  <template id="template-add-contact">
    <div class="modal-header">
      <h2>Add Contact</h2>
      <button class="btn-close" data-close-modal>√ó</button>
    </div>
    <div class="modal-body">
      <div class="contact-quick-add">
        <button class="btn btn-secondary contact-quick" data-type="ship">Ship</button>
        <button class="btn btn-secondary contact-quick" data-type="station">Station</button>
        <button class="btn btn-secondary contact-quick" data-type="debris">Debris</button>
        <button class="btn btn-secondary contact-quick" data-type="asteroid">Asteroid</button>
        <button class="btn btn-secondary contact-quick" data-type="beacon">Beacon</button>
        <button class="btn btn-secondary contact-quick" data-type="unknown">Unknown</button>
      </div>
      <div class="contact-form">
        <div class="form-group">
          <label for="contact-name">Name (optional):</label>
          <input type="text" id="contact-name" placeholder="e.g., Patrol Cutter">
        </div>
        <div class="form-group">
          <label for="contact-type">Type:</label>
          <select id="contact-type">
            <option value="unknown">Unknown</option>
            <option value="ship">Ship</option>
            <option value="station">Station</option>
            <option value="debris">Debris</option>
            <option value="asteroid">Asteroid</option>
            <option value="beacon">Beacon</option>
            <option value="missile">Missile</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="contact-bearing">Bearing (¬∞):</label>
            <input type="number" id="contact-bearing" min="0" max="359" value="0">
          </div>
          <div class="form-group">
            <label for="contact-range">Range (km):</label>
            <input type="number" id="contact-range" min="0" value="10000">
          </div>
        </div>
        <div class="form-group">
          <label for="contact-transponder">Transponder:</label>
          <input type="text" id="contact-transponder" placeholder="e.g., ISS Far Horizon">
        </div>
        <div class="form-group">
          <label for="contact-signature">Signature:</label>
          <select id="contact-signature">
            <option value="minimal">Minimal</option>
            <option value="reduced">Reduced</option>
            <option value="normal" selected>Normal</option>
            <option value="increased">Increased</option>
            <option value="large">Large</option>
          </select>
        </div>
        <div class="form-group">
          <label for="contact-notes">GM Notes:</label>
          <textarea id="contact-notes" rows="2" placeholder="Private notes..."></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button class="btn btn-primary" id="btn-save-contact">Add Contact</button>
    </div>
  </template>

  <!-- Apply System Damage Modal Template (GM) -->
  <template id="template-apply-damage">
    <div class="modal-header">
      <h2>Apply System Damage</h2>
      <button class="btn-close" data-close-modal>√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="damage-system">System:</label>
        <select id="damage-system">
          <option value="mDrive">M-Drive</option>
          <option value="powerPlant">Power Plant</option>
          <option value="jDrive">J-Drive</option>
          <option value="sensors">Sensors</option>
          <option value="computer">Computer</option>
          <option value="armour">Armour</option>
          <option value="weapon">Weapons</option>
          <option value="fuel">Fuel</option>
          <option value="cargo">Cargo</option>
          <option value="crew">Crew</option>
          <option value="hull">Hull</option>
        </select>
      </div>
      <div class="form-group">
        <label for="damage-severity">Severity (1-6):</label>
        <input type="number" id="damage-severity" min="1" max="6" value="1">
        <div class="form-help">
          1-2: Minor damage, 3-4: Major damage, 5-6: Critical/Disabled
        </div>
      </div>
      <div class="damage-effects-preview">
        <h4>Effects Preview</h4>
        <div id="damage-preview-content">
          Select a system to see effects
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button class="btn btn-warning" id="btn-apply-damage">Apply Damage</button>
      <button class="btn btn-success" id="btn-clear-damage">Clear All Damage</button>
    </div>
  </template>

  <!-- Refuel Modal Template -->
  <template id="template-refuel">
    <div class="modal-header">
      <h2>Refuel Ship</h2>
      <button class="btn-close" data-close-modal>√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="refuel-source">Fuel Source:</label>
        <select id="refuel-source" onchange="updateRefuelAmountPreview()">
          <option value="">Loading sources...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="refuel-amount">Amount (tons):</label>
        <div class="input-with-button">
          <input type="number" id="refuel-amount" min="1" value="10" oninput="updateRefuelAmountPreview()">
          <button class="btn btn-small" onclick="setRefuelMax()">Max</button>
        </div>
      </div>
      <div id="refuel-preview" class="refuel-preview">
        <div class="refuel-info">Select source and amount</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button class="btn btn-primary" onclick="executeRefuel()">Refuel</button>
    </div>
  </template>

  <!-- Process Fuel Modal Template -->
  <template id="template-process-fuel">
    <div class="modal-header">
      <h2>Process Unrefined Fuel</h2>
      <button class="btn-close" data-close-modal>√ó</button>
    </div>
    <div class="modal-body">
      <p class="modal-description">
        Convert unrefined fuel to processed fuel using the ship's fuel processor.
        Processing rate: 10 tons per hour.
      </p>
      <div class="form-group">
        <label for="process-amount">Amount to Process (tons):</label>
        <div class="input-with-button">
          <input type="number" id="process-amount" min="1" value="10">
          <button class="btn btn-small" onclick="setProcessMax()">Max</button>
        </div>
      </div>
      <div class="process-info">
        <p><strong>Note:</strong> Processed fuel has no penalties, unlike unrefined fuel.</p>
        <p>Unrefined fuel: -2 DM to jump checks, 5% misjump risk</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button class="btn btn-primary" onclick="executeProcessFuel()">Start Processing</button>
    </div>
  </template>

  <!-- Add Ship Modal Template -->
  <template id="template-add-ship">
    <div class="modal-header">
      <h2>Add Ship</h2>
      <button class="btn-close" data-close-modal>√ó</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="ship-name">Ship Name:</label>
        <input type="text" id="ship-name" placeholder="e.g., The Wandering Star" required>
      </div>
      <div class="form-group">
        <label for="ship-template">Ship Type:</label>
        <select id="ship-template">
          <option value="">Loading templates...</option>
        </select>
      </div>
      <div id="ship-template-info" class="template-info">
        <!-- Populated when template selected -->
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" id="ship-is-party" checked>
          Party Ship (players can select this ship)
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button class="btn btn-primary" id="btn-create-ship">Add Ship</button>
    </div>
  </template>

  <!-- Ship Template Editor Modal (AR-17) -->
  <template id="template-edit-ship">
    <div class="modal-header">
      <h2>Ship Template Editor</h2>
      <button class="btn-close" data-close-modal>√ó</button>
    </div>
    <div class="modal-body ship-editor-body">
      <!-- Template Selector -->
      <div class="editor-section">
        <div class="form-group">
          <label for="edit-ship-name">Ship Name:</label>
          <input type="text" id="edit-ship-name" placeholder="e.g., The Wandering Star" required>
        </div>
        <div class="form-group">
          <label for="edit-ship-template">Base Template:</label>
          <select id="edit-ship-template">
            <option value="">-- Select Base Template --</option>
          </select>
        </div>
        <div id="edit-template-preview" class="template-preview"></div>
      </div>

      <!-- Editor Tabs -->
      <div class="editor-tabs">
        <button class="editor-tab active" data-tab="hull">Hull</button>
        <button class="editor-tab" data-tab="drives">Drives</button>
        <button class="editor-tab" data-tab="weapons">Weapons</button>
        <button class="editor-tab" data-tab="systems">Systems</button>
        <button class="editor-tab" data-tab="cargo">Cargo/Crew</button>
      </div>

      <!-- Hull Tab -->
      <div class="editor-panel" id="editor-panel-hull">
        <h3>Hull & Armor</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="edit-hull-tonnage">Tonnage:</label>
            <input type="number" id="edit-hull-tonnage" min="10" max="5000" step="10" readonly>
            <span class="hint">Fixed from template</span>
          </div>
          <div class="form-group">
            <label for="edit-hull-config">Configuration:</label>
            <select id="edit-hull-config">
              <option value="standard">Standard</option>
              <option value="streamlined">Streamlined</option>
              <option value="distributed">Distributed</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="edit-hull-points">Hull Points:</label>
            <input type="number" id="edit-hull-points" min="1" max="999">
          </div>
          <div class="form-group">
            <label for="edit-armor-rating">Armor Rating:</label>
            <input type="number" id="edit-armor-rating" min="0" max="20">
          </div>
          <div class="form-group">
            <label for="edit-armor-type">Armor Type:</label>
            <select id="edit-armor-type">
              <option value="none">None</option>
              <option value="titanium_steel">Titanium Steel</option>
              <option value="crystaliron">Crystaliron</option>
              <option value="bonded_superdense">Bonded Superdense</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Drives Tab -->
      <div class="editor-panel hidden" id="editor-panel-drives">
        <h3>Drives & Power</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="edit-mdrive-thrust">M-Drive Thrust:</label>
            <select id="edit-mdrive-thrust">
              <option value="0">0G</option>
              <option value="1">1G</option>
              <option value="2">2G</option>
              <option value="3">3G</option>
              <option value="4">4G</option>
              <option value="5">5G</option>
              <option value="6">6G</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-jdrive-rating">Jump Rating:</label>
            <select id="edit-jdrive-rating">
              <option value="0">J-0</option>
              <option value="1">J-1</option>
              <option value="2">J-2</option>
              <option value="3">J-3</option>
              <option value="4">J-4</option>
              <option value="5">J-5</option>
              <option value="6">J-6</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="edit-power-output">Power Output:</label>
            <input type="number" id="edit-power-output" min="1" max="999">
          </div>
          <div class="form-group">
            <label for="edit-fuel-capacity">Fuel Capacity (tons):</label>
            <input type="number" id="edit-fuel-capacity" min="0" max="999">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="edit-computer">Computer:</label>
            <select id="edit-computer">
              <option value="1">Computer/5</option>
              <option value="2">Computer/10</option>
              <option value="3">Computer/15</option>
              <option value="4">Computer/20</option>
              <option value="5">Computer/25</option>
            </select>
          </div>
          <div class="form-group">
            <label for="edit-sensors">Sensors:</label>
            <select id="edit-sensors">
              <option value="civilian">Civilian (DM-2)</option>
              <option value="basic_military">Basic Military (DM0)</option>
              <option value="improved">Improved (DM+1)</option>
              <option value="advanced">Advanced (DM+2)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Weapons Tab -->
      <div class="editor-panel hidden" id="editor-panel-weapons">
        <h3>Weapons</h3>
        <div id="edit-weapons-list" class="weapons-list">
          <!-- Populated dynamically -->
        </div>
        <div class="form-row weapon-add">
          <div class="form-group">
            <select id="edit-weapon-type">
              <option value="pulse_laser">Pulse Laser</option>
              <option value="beam_laser">Beam Laser</option>
              <option value="sandcaster">Sandcaster</option>
              <option value="missile_rack">Missile Rack</option>
              <option value="particle_beam">Particle Beam</option>
            </select>
          </div>
          <div class="form-group">
            <select id="edit-weapon-mount">
              <option value="turret_single">Single Turret</option>
              <option value="turret_double">Double Turret</option>
              <option value="turret_triple">Triple Turret</option>
              <option value="barbette">Barbette</option>
              <option value="bay">Bay</option>
            </select>
          </div>
          <button class="btn btn-secondary" id="btn-add-weapon">+ Add Weapon</button>
        </div>
      </div>

      <!-- Systems Tab -->
      <div class="editor-panel hidden" id="editor-panel-systems">
        <h3>Ship Systems</h3>
        <div id="edit-systems-list" class="systems-list">
          <!-- Populated dynamically -->
        </div>
        <div class="form-row system-add">
          <div class="form-group">
            <select id="edit-system-type">
              <option value="fuel_processor">Fuel Processor</option>
              <option value="fuel_scoops">Fuel Scoops</option>
              <option value="cargo_crane">Cargo Crane</option>
              <option value="repair_drones">Repair Drones</option>
              <option value="probe_drones">Probe Drones</option>
              <option value="medical_bay">Medical Bay</option>
              <option value="workshop">Workshop</option>
            </select>
          </div>
          <button class="btn btn-secondary" id="btn-add-system">+ Add System</button>
        </div>
      </div>

      <!-- Cargo/Crew Tab -->
      <div class="editor-panel hidden" id="editor-panel-cargo">
        <h3>Cargo & Crew Quarters</h3>
        <div class="form-row">
          <div class="form-group">
            <label for="edit-cargo-tonnage">Cargo Hold (tons):</label>
            <input type="number" id="edit-cargo-tonnage" min="0" max="999">
          </div>
          <div class="form-group">
            <label for="edit-staterooms">Staterooms:</label>
            <input type="number" id="edit-staterooms" min="0" max="99">
          </div>
          <div class="form-group">
            <label for="edit-low-berths">Low Berths:</label>
            <input type="number" id="edit-low-berths" min="0" max="99">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="edit-common-areas">Common Areas (tons):</label>
            <input type="number" id="edit-common-areas" min="0" max="99">
          </div>
        </div>
      </div>

      <!-- Validation Summary -->
      <div id="edit-validation-summary" class="validation-summary">
        <!-- Populated dynamically -->
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button class="btn btn-primary" id="btn-save-edited-ship">Save Ship</button>
    </div>
  </template>

  <!-- Ship Status Modal Template (TIP-2) -->
  <template id="template-ship-status">
    <div class="modal-header">
      <h2 id="ship-status-name">Ship Name</h2>
      <button class="btn-close" data-close-modal>√ó</button>
    </div>
    <div class="modal-body">
      <div id="ship-status-content" class="ship-status-content">
        <!-- Populated dynamically -->
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Close</button>
    </div>
  </template>

  <!-- GM Bridge Menu Modal Template -->
  <template id="template-gm-bridge-menu">
    <div class="modal-header">
      <h2>GM Menu</h2>
      <button class="btn-close" data-close-modal>√ó</button>
    </div>
    <div class="modal-body">
      <div class="gm-menu-section">
        <h3>Campaign Code</h3>
        <div class="campaign-code-display large">
          <code id="gm-menu-campaign-code">--------</code>
          <button id="btn-gm-copy-code" class="btn btn-primary">Copy Code</button>
        </div>
        <p class="code-hint">Share this code with players to join</p>
      </div>

      <!-- GOD MODE Section -->
      <div class="gm-menu-section god-mode-section">
        <h3>‚ö° God Mode</h3>
        <div class="god-mode-controls">
          <div class="god-mode-group">
            <label>Ship State</label>
            <div class="god-mode-row">
              <label>Hull:</label>
              <input type="number" id="god-ship-hull" min="0" max="999" class="input-small">
              <label>Fuel:</label>
              <input type="number" id="god-ship-fuel" min="0" max="999" class="input-small">
            </div>
            <div class="god-mode-row">
              <label>Power:</label>
              <input type="number" id="god-ship-power" min="0" max="100" class="input-small">
              <label>Alert:</label>
              <select id="god-ship-alert" class="input-small">
                <option value="NORMAL">NORMAL</option>
                <option value="YELLOW">YELLOW</option>
                <option value="RED">RED</option>
                <option value="BATTLE">BATTLE</option>
              </select>
            </div>
            <button id="btn-god-apply-ship" class="btn btn-warning btn-small">Apply Ship Changes</button>
          </div>

          <div class="god-mode-group">
            <label>Add Contact</label>
            <div class="god-mode-row">
              <input type="text" id="god-contact-name" placeholder="Contact name" class="input-medium">
              <select id="god-contact-type" class="input-small">
                <option value="Unknown">Unknown</option>
                <option value="Free Trader">Free Trader</option>
                <option value="Far Trader">Far Trader</option>
                <option value="Scout">Scout</option>
                <option value="Patrol">Patrol</option>
                <option value="SDB">SDB</option>
                <option value="Cruiser">Cruiser</option>
                <option value="Asteroid">Asteroid</option>
                <option value="Station">Station</option>
              </select>
            </div>
            <div class="god-mode-row">
              <label>Range:</label>
              <input type="number" id="god-contact-range" value="50000" class="input-small">
              <label>km</label>
              <label>Bearing:</label>
              <input type="number" id="god-contact-bearing" value="0" min="0" max="359" class="input-small">
              <label>¬∞</label>
            </div>
            <button id="btn-god-add-contact" class="btn btn-warning btn-small">Add Contact</button>
          </div>

          <div class="god-mode-group">
            <label>Quick Commands</label>
            <div class="god-mode-buttons">
              <button id="btn-god-repair-all" class="btn btn-success btn-small">Repair All</button>
              <button id="btn-god-refuel" class="btn btn-success btn-small">Full Refuel</button>
              <button id="btn-god-clear-contacts" class="btn btn-danger btn-small">Clear Contacts</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Close</button>
    </div>
  </template>

  <!-- Edit Role Personality Modal Template (Stage 2 Autorun 3) -->
  <template id="template-edit-role-personality">
    <div class="modal-header">
      <h2>Personalize Your Station</h2>
      <button class="btn-close" data-close-modal>&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="edit-role-title">Custom Title</label>
        <input type="text" id="edit-role-title" placeholder="e.g., Chief Navigator, Helmsman First Class" maxlength="50">
        <p class="field-hint">Leave blank to use default role name</p>
      </div>
      <div class="form-group">
        <label>Quirk Icon</label>
        <div id="quirk-icon-picker" class="icon-picker">
          <button type="button" class="icon-btn" data-icon="">None</button>
          <button type="button" class="icon-btn" data-icon="*">*</button>
          <button type="button" class="icon-btn" data-icon="+">+</button>
          <button type="button" class="icon-btn" data-icon="#">#</button>
          <button type="button" class="icon-btn" data-icon="@">@</button>
          <button type="button" class="icon-btn" data-icon="!">!</button>
          <button type="button" class="icon-btn" data-icon="~">~</button>
          <button type="button" class="icon-btn" data-icon="^">^</button>
          <button type="button" class="icon-btn" data-icon="&amp;">&amp;</button>
          <button type="button" class="icon-btn" data-icon="%">%</button>
          <button type="button" class="icon-btn" data-icon="$">$</button>
        </div>
      </div>
      <div class="form-group">
        <label for="edit-quirk-text">Quirk / Catchphrase</label>
        <input type="text" id="edit-quirk-text" placeholder="e.g., Always has a mug of coffee" maxlength="100">
        <p class="field-hint">A personality trait or catchphrase for your character at this station</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button id="btn-save-role-personality" class="btn btn-primary">Save</button>
    </div>
  </template>

  <!-- System Lookup Modal Template (Stage 5 Autorun 3, AR-23 Enhanced) -->
  <template id="template-system-lookup">
    <div class="modal-header">
      <h2>Location Manager</h2>
      <button class="btn-close" data-close-modal>&times;</button>
    </div>
    <div class="modal-body">
      <!-- AR-23.7: Quick Location Buttons -->
      <div class="quick-locations-section">
        <div class="quick-locations-header">
          <span>Quick Locations</span>
          <button id="btn-set-home" class="btn btn-sm" title="Set current location as home system">Set Home</button>
        </div>
        <div id="home-system-btn" class="quick-location-item home-location hidden">
          <span class="location-icon">&#x1F3E0;</span>
          <span class="location-name">Home System</span>
        </div>
        <div id="recent-locations" class="quick-location-list">
          <p class="quick-placeholder">No recent locations</p>
        </div>
        <div class="favorites-header">
          <span>Favorites</span>
        </div>
        <div id="favorite-locations" class="quick-location-list">
          <p class="quick-placeholder">No favorites saved</p>
        </div>
      </div>

      <!-- AR-23.6: Deep Space Mode Toggle -->
      <div class="deep-space-section">
        <label class="toggle-label">
          <input type="checkbox" id="deep-space-toggle">
          <span>Deep Space Mode</span>
          <span class="field-hint">(Ship is in jump space or between systems)</span>
        </label>
        <div id="deep-space-fields" class="deep-space-fields hidden">
          <div class="form-row">
            <div class="form-group">
              <label for="deep-space-reference">Reference System:</label>
              <input type="text" id="deep-space-reference" placeholder="Origin system name" readonly>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="deep-space-bearing">Bearing (degrees):</label>
              <input type="number" id="deep-space-bearing" min="0" max="359" placeholder="0-359">
            </div>
            <div class="form-group">
              <label for="deep-space-distance">Distance (parsecs):</label>
              <input type="number" id="deep-space-distance" min="0" step="0.1" placeholder="e.g., 2.5">
            </div>
          </div>
          <button id="btn-update-deep-space" class="btn btn-primary">Update Deep Space Position</button>
        </div>
      </div>

      <hr class="section-divider">

      <!-- Original search section -->
      <div class="form-group">
        <label for="system-search-input">Search TravellerMap:</label>
        <div class="search-input-group">
          <input type="text" id="system-search-input" placeholder="e.g., Regina, Mora, Efate..." maxlength="50">
          <button id="btn-system-search" class="btn btn-primary">Search</button>
        </div>
        <p class="field-hint">Search TravellerMap for world data. Use * for wildcards.</p>
      </div>
      <div id="system-search-results" class="system-search-results">
        <p class="search-placeholder">Enter a system name and click Search</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button id="btn-toggle-favorite" class="btn btn-secondary" disabled title="Add/remove from favorites">&#x2606; Favorite</button>
      <button id="btn-set-system" class="btn btn-primary" disabled>Set as Current Location</button>
    </div>
  </template>

  <!-- Stage 9.3: Player Mail Inbox Template -->
  <template id="template-player-mail">
    <div class="modal-header">
      <h2>Ship Mail</h2>
      <button class="btn-close" data-close-modal>√ó</button>
    </div>
    <div class="modal-body mail-inbox">
      <div class="mail-list" id="player-mail-list">
        <p class="placeholder">No messages</p>
      </div>
      <div class="mail-detail hidden" id="mail-detail">
        <div class="mail-detail-header">
          <span class="mail-from" id="mail-detail-from"></span>
          <span class="mail-date" id="mail-detail-date"></span>
        </div>
        <div class="mail-detail-subject" id="mail-detail-subject"></div>
        <div class="mail-detail-body" id="mail-detail-body"></div>
        <div class="mail-detail-actions">
          <button class="btn btn-secondary" id="btn-mail-back">Back</button>
          <button class="btn btn-primary" id="btn-mail-reply">Reply</button>
          <button class="btn btn-warning" id="btn-mail-archive">Archive</button>
        </div>
      </div>
      <div class="mail-compose hidden" id="mail-compose">
        <div class="form-group">
          <label>To: <span id="compose-to"></span></label>
        </div>
        <div class="form-group">
          <label for="compose-subject">Subject:</label>
          <input type="text" id="compose-subject">
        </div>
        <div class="form-group">
          <label for="compose-body">Message:</label>
          <textarea id="compose-body" rows="5"></textarea>
        </div>
        <div class="mail-compose-actions">
          <button class="btn btn-secondary" id="btn-compose-cancel">Cancel</button>
          <button class="btn btn-primary" id="btn-compose-send">Send</button>
        </div>
      </div>
    </div>
  </template>

  <!-- Stage 9.3: Handout Viewer Template -->
  <template id="template-handout-viewer">
    <div class="modal-header">
      <h2 id="handout-title">Handout</h2>
      <button class="btn-close" data-close-modal>√ó</button>
    </div>
    <div class="modal-body handout-viewer">
      <div id="handout-content" class="handout-content"></div>
    </div>
  </template>

  <!-- TIP-3: UWP Tooltip Container -->
  <div id="uwp-tooltip-container"></div>

  <!-- Stage 7: Character Sheet Tooltip Container -->
  <div id="character-tooltip-container"></div>

  <!-- AR-29.7: Sector Map Overlay -->
  <div id="sector-map-container" class="sector-map-overlay" style="display: none;">
    <div class="esc-hint">ESC to close</div>
    <div class="sector-map-header">
      <h3 id="sector-map-title">Shared Map of Known Space</h3>
      <select id="sector-selector" onchange="loadSectorData(this.value)" title="Select subsector">
        <option value="district268">District 268</option>
        <option value="five-sisters">Five Sisters</option>
        <option value="glisten">Glisten</option>
        <option value="trins-veil">Trin's Veil</option>
      </select>
      <div class="sector-zoom-controls">
        <button class="btn btn-icon btn-small" onclick="zoomSectorMap(1.2)" title="Zoom In">+</button>
        <button class="btn btn-icon btn-small" onclick="zoomSectorMap(0.8)" title="Zoom Out">‚àí</button>
        <button class="btn btn-icon btn-small" onclick="resetSectorZoom()" title="Reset Zoom">‚ü≤</button>
      </div>
      <button class="btn btn-icon" onclick="hideSectorMap()" title="Close">√ó</button>
    </div>
    <div id="sector-map-canvas-container" class="sector-map-content"></div>
  </div>

  <!-- AR-29.6: Star System Map Overlay -->
  <div id="system-map-container" class="system-map-overlay" style="display: none;">
    <div class="esc-hint">ESC to close</div>
    <div class="system-map-header">
      <h3 id="system-map-title">Shared System Map</h3>
      <div class="system-map-controls">
        <button class="btn btn-icon btn-small" onclick="zoomSystemMap(1.3)" title="Zoom In">+</button>
        <button class="btn btn-icon btn-small" onclick="zoomSystemMap(0.7)" title="Zoom Out">‚àí</button>
        <button class="btn btn-icon btn-small" onclick="resetSystemMapView()" title="Reset View">‚ü≤</button>
        <button class="btn btn-icon btn-small" onclick="toggleSystemMapLabels()" title="Toggle Labels">T</button>
      </div>
      <button class="btn btn-icon" onclick="hideSystemMap()" title="Close">√ó</button>
    </div>
    <div id="system-map-canvas-container" class="system-map-content"></div>
    <div id="system-map-info-panel" class="system-map-info" style="display: none;"></div>
    <div id="system-map-places" class="system-map-places" style="display: none;"></div>
  </div>

  <!-- Footer - Legal/Attribution (moved from login for cleaner UI) -->
  <footer id="app-footer" class="app-footer">
    <span>Traveller ¬© Far Future Enterprises. Created by Bruce Stephenson. MIT License.</span>
  </footer>

  <script src="/socket.io/socket.io.js"></script>
  <script src="modules/subsector-map.js"></script>
  <script src="app.js" type="module"></script>
</body>
</html>
