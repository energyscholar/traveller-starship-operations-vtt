<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Traveller Starship Operations</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">
    <!-- Login Screen (GM or Player) -->
    <div id="login-screen" class="screen active">
      <div class="login-container">
        <h1 class="title">Traveller Starship Operations</h1>
        <p class="subtitle">Virtual Tabletop for Mongoose Traveller 2E</p>

        <div class="login-options">
          <button id="btn-gm-login" class="btn btn-primary btn-large">
            GM Login
          </button>
          <button id="btn-player-login" class="btn btn-secondary btn-large">
            Player Login
          </button>
        </div>

        <div id="campaign-select" class="hidden">
          <h2>Select Campaign</h2>
          <div id="campaign-list" class="campaign-list">
            <!-- Populated dynamically -->
          </div>
          <button id="btn-create-campaign" class="btn btn-success">
            + Create New Campaign
          </button>
          <button id="btn-back-login" class="btn btn-link">Back</button>
        </div>

        <div id="player-select" class="hidden">
          <h2>Join Campaign</h2>
          <div class="form-group">
            <label for="campaign-code">Campaign Code:</label>
            <input type="text" id="campaign-code" placeholder="Enter campaign code">
          </div>
          <div class="join-options">
            <button id="btn-join-campaign" class="btn btn-primary">Join as Player</button>
            <button id="btn-join-guest" class="btn btn-secondary">Join as Guest</button>
          </div>
          <p class="guest-info">Guests can take any role with skill 0. GM can override skill level.</p>
          <button id="btn-back-player" class="btn btn-link">Back</button>
        </div>

        <div id="guest-name-select" class="hidden">
          <h2>Guest Login</h2>
          <div class="form-group">
            <label for="guest-name">Your Name:</label>
            <input type="text" id="guest-name" placeholder="Enter your name">
          </div>
          <button id="btn-confirm-guest" class="btn btn-primary">Join as Guest</button>
          <button id="btn-back-guest" class="btn btn-link">Back</button>
        </div>

        <div id="player-slot-select" class="hidden">
          <h2>Select Your Slot</h2>
          <div id="player-slot-list" class="slot-list">
            <!-- Populated dynamically -->
          </div>
          <button id="btn-back-player-slot" class="btn btn-link">Back</button>
        </div>
      </div>
    </div>

    <!-- GM Setup Screen -->
    <div id="gm-setup-screen" class="screen">
      <header class="header">
        <h1 id="gm-campaign-name">Campaign Setup</h1>
        <div class="header-actions">
          <button id="btn-gm-settings" class="btn btn-icon" title="Settings">⚙</button>
          <button id="btn-gm-logout" class="btn btn-link">Logout</button>
        </div>
      </header>

      <div class="gm-setup-container">
        <!-- Campaign Code Section -->
        <section class="setup-section campaign-code-section">
          <h2>Campaign Code</h2>
          <div class="campaign-code-display">
            <code id="campaign-code-value">--------</code>
            <button id="btn-copy-code" class="btn btn-small" title="Copy to clipboard">Copy</button>
          </div>
          <p class="code-hint">Share this code with players to join</p>
        </section>

        <section class="setup-section">
          <h2>Player Slots</h2>
          <div id="gm-player-slots" class="player-slots">
            <!-- Populated dynamically -->
          </div>
          <div class="add-slot-form">
            <input type="text" id="new-slot-name" placeholder="Player name">
            <button id="btn-add-player-slot" class="btn btn-success">+ Add Slot</button>
          </div>
        </section>

        <section class="setup-section">
          <h2>Ships</h2>
          <div id="gm-ships-list" class="ships-list">
            <!-- Populated dynamically -->
          </div>
          <button id="btn-add-ship" class="btn btn-success">+ Add Ship</button>
        </section>

        <section class="setup-section">
          <h2>Campaign Settings</h2>
          <div class="form-group">
            <label>Current Date:</label>
            <input type="text" id="campaign-date" placeholder="1105-001">
          </div>
          <div class="form-group">
            <label>Current System:</label>
            <input type="text" id="campaign-system" placeholder="Regina">
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="god-mode-toggle">
              God Mode (Full Control)
            </label>
          </div>
        </section>

        <div class="setup-actions">
          <button id="btn-start-session" class="btn btn-primary btn-large">
            Start Session
          </button>
        </div>
      </div>
    </div>

    <!-- Player Setup Screen (Character/Role Selection) -->
    <div id="player-setup-screen" class="screen">
      <header class="header">
        <h1 id="player-slot-name">Player Setup</h1>
        <button id="btn-player-logout" class="btn btn-link">Logout</button>
      </header>

      <div class="player-setup-container">
        <section class="setup-section">
          <h2>Your Character</h2>
          <div id="character-display" class="character-card">
            <p class="placeholder">No character imported</p>
          </div>
          <div class="character-actions">
            <button id="btn-import-character" class="btn btn-secondary">Import Character</button>
            <button id="btn-quick-character" class="btn btn-link">Quick Create</button>
          </div>
        </section>

        <section class="setup-section">
          <h2>Select Ship</h2>
          <div id="ship-select-list" class="ship-select-list">
            <!-- Populated dynamically -->
          </div>
        </section>

        <section class="setup-section">
          <h2>Select Crew Role</h2>
          <div id="role-select-list" class="role-select-list">
            <!-- Populated dynamically -->
          </div>
        </section>

        <div class="setup-actions">
          <button id="btn-join-bridge" class="btn btn-primary btn-large" disabled>
            Join Bridge
          </button>
        </div>
      </div>
    </div>

    <!-- Bridge View (Main Operations Screen) -->
    <div id="bridge-screen" class="screen">
      <header class="bridge-header">
        <div class="ship-info">
          <h1 id="bridge-ship-name">Ship Name</h1>
          <span id="bridge-date" class="date-display">1105-001 12:00</span>
        </div>
        <div id="guest-indicator" class="guest-indicator hidden">
          <span class="guest-badge">GUEST</span>
        </div>
        <div id="alert-status" class="alert-status normal">
          <span class="alert-indicator"></span>
          <span class="alert-text">NORMAL</span>
        </div>
        <div class="header-actions">
          <button id="btn-bridge-menu" class="btn btn-icon" title="Menu">☰</button>
        </div>
      </header>

      <!-- Ship Status Bar -->
      <section id="ship-status-bar" class="ship-status-bar">
        <div class="status-item">
          <span class="status-label">Hull</span>
          <div class="status-bar-container">
            <div id="hull-bar" class="status-bar hull-bar" style="width: 100%"></div>
          </div>
          <span id="hull-value" class="status-value">100%</span>
        </div>
        <div class="status-item">
          <span class="status-label">Fuel</span>
          <div class="status-bar-container">
            <div id="fuel-bar" class="status-bar fuel-bar" style="width: 100%"></div>
          </div>
          <span id="fuel-value" class="status-value">40/40</span>
        </div>
        <div class="status-item">
          <span class="status-label">Power</span>
          <div class="status-bar-container">
            <div id="power-bar" class="status-bar power-bar" style="width: 100%"></div>
          </div>
          <span id="power-value" class="status-value">100%</span>
        </div>
        <div class="status-item location-item">
          <span class="status-label">Location</span>
          <span id="location-value" class="status-value location-value">Regina System</span>
        </div>
      </section>

      <main class="bridge-main">
        <!-- Sensor Display (Top) -->
        <section id="sensor-display" class="sensor-panel">
          <div class="panel-header">
            <h2>Sensor Display</h2>
            <span id="sensor-status" class="status-indicator">PASSIVE</span>
          </div>
          <div id="sensor-contacts" class="contacts-list">
            <p class="placeholder">No contacts detected</p>
          </div>
        </section>

        <!-- Role Panel (Bottom Left) - Changes based on role -->
        <section id="role-panel" class="role-panel">
          <div class="panel-header">
            <h2 id="role-panel-title">Your Role</h2>
            <span id="role-name" class="role-indicator">Pilot</span>
          </div>
          <div id="role-actions" class="role-actions">
            <!-- Populated based on role -->
          </div>
          <!-- Role-specific detail view (expandable) -->
          <div id="role-detail-view" class="role-detail hidden">
            <!-- Populated based on role -->
          </div>
          <button id="btn-toggle-detail" class="btn btn-link">Show Details ▼</button>
        </section>

        <!-- Crew Status (Bottom Center) -->
        <section id="crew-panel" class="crew-panel">
          <div class="panel-header">
            <h2>Crew Status</h2>
          </div>
          <div id="crew-list" class="crew-list">
            <!-- Populated dynamically -->
          </div>
        </section>

        <!-- Ship Log (Bottom Right) -->
        <section id="log-panel" class="log-panel">
          <div class="panel-header">
            <h2>Ship Log</h2>
            <button id="btn-add-log" class="btn btn-small">+ Add Note</button>
          </div>
          <div id="ship-log" class="ship-log">
            <!-- Populated dynamically -->
          </div>
        </section>
      </main>

      <!-- GM Overlay (shown when GM is viewing) -->
      <div id="gm-overlay" class="gm-overlay hidden">
        <div class="gm-controls">
          <button id="btn-gm-advance-time" class="btn">Advance Time</button>
          <button id="btn-gm-add-contact" class="btn">Add Contact</button>
          <button id="btn-gm-damage" class="btn btn-warning">System Damage</button>
          <button id="btn-gm-initiative" class="btn btn-warning">Call Initiative</button>
          <button id="btn-gm-combat" class="btn btn-danger">Start Combat</button>
        </div>
      </div>
    </div>

    <!-- Combat Screen (Placeholder - to be integrated with existing) -->
    <div id="combat-screen" class="screen">
      <header class="combat-header">
        <h1>COMBAT MODE</h1>
        <button id="btn-exit-combat" class="btn btn-secondary">Exit Combat</button>
      </header>
      <main id="combat-main">
        <!-- Combat UI will be loaded here -->
        <p class="placeholder">Combat system integration pending...</p>
      </main>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="modal-overlay hidden">
      <div id="modal-content" class="modal-content">
        <!-- Modal content populated dynamically -->
      </div>
    </div>
  </div>

  <!-- Character Import Modal Template -->
  <template id="template-character-import">
    <div class="modal-header">
      <h2>Import Character</h2>
      <button class="btn-close" data-close-modal>×</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="char-name">Character Name:</label>
        <input type="text" id="char-name" required>
      </div>
      <div class="form-group">
        <label>Skills (relevant to ship operations):</label>
        <div class="skill-inputs">
          <div class="skill-row">
            <label>Pilot:</label>
            <input type="number" id="skill-pilot" min="0" max="6" value="0">
          </div>
          <div class="skill-row">
            <label>Astrogation:</label>
            <input type="number" id="skill-astrogation" min="0" max="6" value="0">
          </div>
          <div class="skill-row">
            <label>Engineer:</label>
            <input type="number" id="skill-engineer" min="0" max="6" value="0">
          </div>
          <div class="skill-row">
            <label>Gunnery:</label>
            <input type="number" id="skill-gunnery" min="0" max="6" value="0">
          </div>
          <div class="skill-row">
            <label>Sensors:</label>
            <input type="number" id="skill-sensors" min="0" max="6" value="0">
          </div>
          <div class="skill-row">
            <label>Leadership:</label>
            <input type="number" id="skill-leadership" min="0" max="6" value="0">
          </div>
          <div class="skill-row">
            <label>Tactics:</label>
            <input type="number" id="skill-tactics" min="0" max="6" value="0">
          </div>
        </div>
      </div>
      <div class="form-group">
        <label>Stats:</label>
        <div class="stat-inputs">
          <div class="stat-row">
            <label>DEX:</label>
            <input type="number" id="stat-dex" min="1" max="15" value="7">
          </div>
          <div class="stat-row">
            <label>INT:</label>
            <input type="number" id="stat-int" min="1" max="15" value="7">
          </div>
          <div class="stat-row">
            <label>EDU:</label>
            <input type="number" id="stat-edu" min="1" max="15" value="7">
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button class="btn btn-primary" id="btn-save-character">Save Character</button>
    </div>
  </template>

  <!-- Create Campaign Modal Template -->
  <template id="template-create-campaign">
    <div class="modal-header">
      <h2>Create New Campaign</h2>
      <button class="btn-close" data-close-modal>×</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="new-campaign-name">Campaign Name:</label>
        <input type="text" id="new-campaign-name" placeholder="Spinward Marches Campaign" required>
      </div>
      <div class="form-group">
        <label for="gm-name">Your Name (GM):</label>
        <input type="text" id="gm-name" placeholder="Bruce" required>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button class="btn btn-primary" id="btn-confirm-create-campaign">Create Campaign</button>
    </div>
  </template>

  <!-- Time Advance Modal Template -->
  <template id="template-time-advance">
    <div class="modal-header">
      <h2>Advance Time</h2>
      <button class="btn-close" data-close-modal>×</button>
    </div>
    <div class="modal-body">
      <div class="time-quick-buttons">
        <button class="btn btn-secondary time-quick" data-minutes="10">+10 min</button>
        <button class="btn btn-secondary time-quick" data-minutes="30">+30 min</button>
        <button class="btn btn-secondary time-quick" data-hours="1">+1 hour</button>
        <button class="btn btn-secondary time-quick" data-hours="4">+4 hours</button>
        <button class="btn btn-secondary time-quick" data-hours="8">+8 hours</button>
        <button class="btn btn-secondary time-quick" data-hours="24">+1 day</button>
      </div>
      <div class="time-custom">
        <h4>Custom Time</h4>
        <div class="time-custom-inputs">
          <div class="form-group inline">
            <input type="number" id="custom-hours" min="0" max="999" value="0">
            <label>hours</label>
          </div>
          <div class="form-group inline">
            <input type="number" id="custom-minutes" min="0" max="59" value="0">
            <label>minutes</label>
          </div>
        </div>
        <button class="btn btn-primary" id="btn-custom-time">Advance</button>
      </div>
    </div>
  </template>

  <!-- Add Contact Modal Template -->
  <template id="template-add-contact">
    <div class="modal-header">
      <h2>Add Contact</h2>
      <button class="btn-close" data-close-modal>×</button>
    </div>
    <div class="modal-body">
      <div class="contact-quick-add">
        <button class="btn btn-secondary contact-quick" data-type="ship">Ship</button>
        <button class="btn btn-secondary contact-quick" data-type="station">Station</button>
        <button class="btn btn-secondary contact-quick" data-type="debris">Debris</button>
        <button class="btn btn-secondary contact-quick" data-type="asteroid">Asteroid</button>
        <button class="btn btn-secondary contact-quick" data-type="beacon">Beacon</button>
        <button class="btn btn-secondary contact-quick" data-type="unknown">Unknown</button>
      </div>
      <div class="contact-form">
        <div class="form-group">
          <label for="contact-name">Name (optional):</label>
          <input type="text" id="contact-name" placeholder="e.g., Patrol Cutter">
        </div>
        <div class="form-group">
          <label for="contact-type">Type:</label>
          <select id="contact-type">
            <option value="unknown">Unknown</option>
            <option value="ship">Ship</option>
            <option value="station">Station</option>
            <option value="debris">Debris</option>
            <option value="asteroid">Asteroid</option>
            <option value="beacon">Beacon</option>
            <option value="missile">Missile</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label for="contact-bearing">Bearing (°):</label>
            <input type="number" id="contact-bearing" min="0" max="359" value="0">
          </div>
          <div class="form-group">
            <label for="contact-range">Range (km):</label>
            <input type="number" id="contact-range" min="0" value="10000">
          </div>
        </div>
        <div class="form-group">
          <label for="contact-transponder">Transponder:</label>
          <input type="text" id="contact-transponder" placeholder="e.g., ISS Far Horizon">
        </div>
        <div class="form-group">
          <label for="contact-signature">Signature:</label>
          <select id="contact-signature">
            <option value="minimal">Minimal</option>
            <option value="reduced">Reduced</option>
            <option value="normal" selected>Normal</option>
            <option value="increased">Increased</option>
            <option value="large">Large</option>
          </select>
        </div>
        <div class="form-group">
          <label for="contact-notes">GM Notes:</label>
          <textarea id="contact-notes" rows="2" placeholder="Private notes..."></textarea>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button class="btn btn-primary" id="btn-save-contact">Add Contact</button>
    </div>
  </template>

  <!-- Apply System Damage Modal Template (GM) -->
  <template id="template-apply-damage">
    <div class="modal-header">
      <h2>Apply System Damage</h2>
      <button class="btn-close" data-close-modal>×</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="damage-system">System:</label>
        <select id="damage-system">
          <option value="mDrive">M-Drive</option>
          <option value="powerPlant">Power Plant</option>
          <option value="jDrive">J-Drive</option>
          <option value="sensors">Sensors</option>
          <option value="computer">Computer</option>
          <option value="armour">Armour</option>
          <option value="weapon">Weapons</option>
          <option value="fuel">Fuel</option>
          <option value="cargo">Cargo</option>
          <option value="crew">Crew</option>
          <option value="hull">Hull</option>
        </select>
      </div>
      <div class="form-group">
        <label for="damage-severity">Severity (1-6):</label>
        <input type="number" id="damage-severity" min="1" max="6" value="1">
        <div class="form-help">
          1-2: Minor damage, 3-4: Major damage, 5-6: Critical/Disabled
        </div>
      </div>
      <div class="damage-effects-preview">
        <h4>Effects Preview</h4>
        <div id="damage-preview-content">
          Select a system to see effects
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button class="btn btn-warning" id="btn-apply-damage">Apply Damage</button>
      <button class="btn btn-success" id="btn-clear-damage">Clear All Damage</button>
    </div>
  </template>

  <!-- Refuel Modal Template -->
  <template id="template-refuel">
    <div class="modal-header">
      <h2>Refuel Ship</h2>
      <button class="btn-close" data-close-modal>×</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="refuel-source">Fuel Source:</label>
        <select id="refuel-source" onchange="updateRefuelAmountPreview()">
          <option value="">Loading sources...</option>
        </select>
      </div>
      <div class="form-group">
        <label for="refuel-amount">Amount (tons):</label>
        <div class="input-with-button">
          <input type="number" id="refuel-amount" min="1" value="10" oninput="updateRefuelAmountPreview()">
          <button class="btn btn-small" onclick="setRefuelMax()">Max</button>
        </div>
      </div>
      <div id="refuel-preview" class="refuel-preview">
        <div class="refuel-info">Select source and amount</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button class="btn btn-primary" onclick="executeRefuel()">Refuel</button>
    </div>
  </template>

  <!-- Process Fuel Modal Template -->
  <template id="template-process-fuel">
    <div class="modal-header">
      <h2>Process Unrefined Fuel</h2>
      <button class="btn-close" data-close-modal>×</button>
    </div>
    <div class="modal-body">
      <p class="modal-description">
        Convert unrefined fuel to processed fuel using the ship's fuel processor.
        Processing rate: 10 tons per hour.
      </p>
      <div class="form-group">
        <label for="process-amount">Amount to Process (tons):</label>
        <div class="input-with-button">
          <input type="number" id="process-amount" min="1" value="10">
          <button class="btn btn-small" onclick="setProcessMax()">Max</button>
        </div>
      </div>
      <div class="process-info">
        <p><strong>Note:</strong> Processed fuel has no penalties, unlike unrefined fuel.</p>
        <p>Unrefined fuel: -2 DM to jump checks, 5% misjump risk</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button class="btn btn-primary" onclick="executeProcessFuel()">Start Processing</button>
    </div>
  </template>

  <!-- Add Ship Modal Template -->
  <template id="template-add-ship">
    <div class="modal-header">
      <h2>Add Ship</h2>
      <button class="btn-close" data-close-modal>×</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="ship-name">Ship Name:</label>
        <input type="text" id="ship-name" placeholder="e.g., The Wandering Star" required>
      </div>
      <div class="form-group">
        <label for="ship-template">Ship Type:</label>
        <select id="ship-template">
          <option value="">Loading templates...</option>
        </select>
      </div>
      <div id="ship-template-info" class="template-info">
        <!-- Populated when template selected -->
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" id="ship-is-party" checked>
          Party Ship (players can select this ship)
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-close-modal>Cancel</button>
      <button class="btn btn-primary" id="btn-create-ship">Add Ship</button>
    </div>
  </template>

  <script src="/socket.io/socket.io.js"></script>
  <script src="app.js" type="module"></script>
</body>
</html>
