<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Traveller Combat VTT - Stage 4</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    h1 {
      font-size: 36px;
      margin-bottom: 10px;
    }
    
    .stage {
      font-size: 14px;
      opacity: 0.8;
      letter-spacing: 2px;
    }
    
    .card {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .card h2 {
      margin-bottom: 15px;
      font-size: 20px;
    }
    
    .status {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    .status-dot.connected {
      background: #00ff00;
    }
    
    .status-dot.disconnected {
      background: #ff0000;
      animation: none;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    
    .combat-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    label {
      font-size: 14px;
      font-weight: 600;
    }

    /* Stage 3: Visual distinction for ship ownership */
    label.your-ship {
      color: #00ff00;
      text-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
    }

    label.your-ship::before {
      content: "üë§ ";
    }

    label.opponent-ship {
      color: #ff6b6b;
      text-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
    }

    label.opponent-ship::before {
      content: "üéØ ";
    }
    
    select {
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
      border: none;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      cursor: pointer;
    }
    
    select option {
      background: #764ba2;
      color: #fff;
    }
    
    button {
      width: 100%;
      padding: 14px 24px;
      font-size: 18px;
      font-weight: bold;
      background: #00ff00;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    button:hover {
      background: #00cc00;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 255, 0, 0.4);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    button:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }
    
    button.test-btn {
      background: #ffa500;
      font-size: 14px;
      padding: 10px 16px;
      margin-top: 10px;
    }
    
    button.test-btn:hover {
      background: #ff8c00;
    }
    
    .combat-log {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }
    
    .log-entry {
      margin-bottom: 15px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      border-left: 4px solid #00ff00;
    }
    
    .log-entry.miss {
      border-left-color: #ff6b6b;
    }
    
    .log-entry.hit {
      border-left-color: #00ff00;
    }
    
    .log-entry.test {
      border-left-color: #ffa500;
    }
    
    .log-entry.test-pass {
      border-left-color: #00ff00;
    }
    
    .log-entry.test-fail {
      border-left-color: #ff0000;
    }
    
    .log-header {
      font-weight: bold;
      margin-bottom: 6px;
      font-size: 14px;
    }
    
    .log-details {
      opacity: 0.9;
      font-size: 12px;
    }
    
    .stat-line {
      margin: 3px 0;
    }
    
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 11px;
      font-weight: bold;
      margin-right: 6px;
    }
    
    .badge.hit {
      background: #00ff00;
      color: #000;
    }
    
    .badge.miss {
      background: #ff6b6b;
      color: #fff;
    }
    
    .badge.pass {
      background: #00ff00;
      color: #000;
    }
    
    .badge.fail {
      background: #ff0000;
      color: #fff;
    }
    
    .ship-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .ship-card {
      background: rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: 8px;
    }
    
    .ship-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .ship-stat {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
      font-size: 14px;
    }
    
    .instructions {
      background: rgba(0, 0, 0, 0.2);
      padding: 12px;
      border-radius: 6px;
      font-size: 13px;
      line-height: 1.6;
      margin-bottom: 15px;
    }
    
    .test-mode {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 1000;
    }
    
    .test-mode button {
      width: auto;
      padding: 12px 20px;
      font-size: 14px;
      background: #ffa500;
      box-shadow: 0 4px 12px rgba(255, 165, 0, 0.4);
    }
    
    .test-mode button:hover {
      background: #ff8c00;
    }

    /* Stage 4: Turn indicator styles */
    .turn-indicator {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      border: 2px solid transparent;
      transition: all 0.3s;
    }

    .turn-indicator.your-turn {
      background: rgba(0, 255, 0, 0.2);
      border-color: #00ff00;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
      animation: pulse-green 2s infinite;
    }

    .turn-indicator.opponent-turn {
      background: rgba(255, 107, 107, 0.2);
      border-color: #ff6b6b;
    }

    .turn-indicator.waiting {
      background: rgba(255, 165, 0, 0.2);
      border-color: #ffa500;
    }

    @keyframes pulse-green {
      0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 0, 0.3); }
      50% { box-shadow: 0 0 30px rgba(0, 255, 0, 0.6); }
    }

    .round-display {
      font-size: 16px;
      margin-top: 8px;
      opacity: 0.9;
    }

    button.start-game {
      background: #4CAF50;
    }

    button.start-game:hover {
      background: #45a049;
    }

    button.end-turn {
      background: #2196F3;
      font-size: 16px;
    }

    button.end-turn:hover {
      background: #1976D2;
    }

    /* Stage 6: Crew roster styles */
    .crew-roster {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    .crew-section {
      background: #2d2d2d;
      padding: 15px;
      border-radius: 8px;
    }

    .crew-ship-name {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 12px;
      color: #ffa500;
    }

    .crew-member {
      background: #1a1a1a;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      border-left: 3px solid #4CAF50;
    }

    .crew-role {
      font-weight: bold;
      color: #ffa500;
      margin-bottom: 4px;
    }

    .crew-name {
      font-size: 14px;
      color: #e0e0e0;
      margin-bottom: 4px;
    }

    .crew-skills {
      font-size: 12px;
      color: #4CAF50;
      margin-bottom: 4px;
    }

    .crew-health {
      font-size: 12px;
      color: #2196F3;
    }

    button.repair-button {
      background: #FF9800;
      font-size: 16px;
    }

    button.repair-button:hover {
      background: #F57C00;
    }

    /* Stage 7: Hex grid styles */
    .grid-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    #hexGrid {
      background: #1a1a1a;
      border: 2px solid #333;
      border-radius: 8px;
      cursor: crosshair;
    }

    .hex {
      fill: #2d2d2d;
      stroke: #444;
      stroke-width: 1;
      transition: fill 0.2s;
    }

    .hex:hover {
      fill: #3d3d3d;
    }

    .hex.valid-move {
      fill: #2d4d2d;
      cursor: pointer;
    }

    .hex.valid-move:hover {
      fill: #3d6d3d;
    }

    .hex.selected {
      fill: #4d4d2d;
    }

    .ship-marker {
      cursor: pointer;
    }

    .ship-marker.scout {
      fill: #4CAF50;
    }

    .ship-marker.corsair {
      fill: #f44336;
    }

    .grid-info {
      display: flex;
      gap: 20px;
      font-size: 14px;
      color: #e0e0e0;
    }

    .grid-info span {
      color: #4CAF50;
      font-weight: bold;
    }

    /* Stage 8.6: Ship Selection Screen */
    #ship-selection-screen {
      display: block;
    }

    #space-combat-screen {
      display: none;
    }

    .mode-selector {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }

    .mode-btn {
      flex: 1;
      padding: 15px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: #fff;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }

    .mode-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .mode-btn.selected {
      background: rgba(0, 255, 0, 0.2);
      border-color: #00ff00;
    }

    .ship-selection-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .ship-option {
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .ship-option:hover {
      background: rgba(0, 0, 0, 0.4);
      border-color: rgba(255, 255, 255, 0.5);
      transform: translateY(-2px);
    }

    .ship-option.selected {
      background: rgba(0, 255, 0, 0.2);
      border-color: #00ff00;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
    }

    .ship-option-header {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #00ff00;
    }

    .ship-option-type {
      font-size: 14px;
      opacity: 0.8;
      margin-bottom: 15px;
    }

    .ship-option-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .ship-option-description {
      font-size: 13px;
      opacity: 0.9;
      font-style: italic;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .range-selection {
      margin-bottom: 20px;
    }

    .range-selection label {
      display: block;
      margin-bottom: 8px;
      font-size: 16px;
      font-weight: bold;
    }

    .range-selection select {
      width: 100%;
    }

    .ready-section {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .ready-indicators {
      display: flex;
      gap: 15px;
      flex: 1;
    }

    .ready-indicator {
      flex: 1;
      padding: 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      text-align: center;
      font-size: 14px;
    }

    .ready-indicator.ready {
      background: rgba(0, 255, 0, 0.2);
      color: #00ff00;
    }

    .ready-indicator.waiting {
      background: rgba(255, 165, 0, 0.2);
      color: #ffa500;
    }

    #ready-button {
      min-width: 150px;
      flex-shrink: 0;
    }

    #ready-status {
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
      opacity: 0.9;
    }

    /* Stage 8.7: Space Combat HUD Styles */
    #space-combat-hud {
      display: none;
    }

    .hud-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .hud-ship-info {
      flex: 1;
    }

    .hud-ship-name {
      font-size: 24px;
      font-weight: bold;
      color: #00ff00;
      margin-bottom: 4px;
    }

    .hud-ship-type {
      font-size: 14px;
      opacity: 0.8;
    }

    .hud-stats {
      display: flex;
      gap: 20px;
    }

    .hud-stat {
      text-align: right;
    }

    .hud-stat-label {
      font-size: 12px;
      opacity: 0.7;
      margin-right: 5px;
    }

    .hud-stat-value {
      font-size: 18px;
      font-weight: bold;
      color: #00ff00;
    }

    .hud-hull-section {
      margin-bottom: 15px;
    }

    .hud-hull-label {
      font-size: 14px;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .hud-hull-bar {
      width: 100%;
      height: 30px;
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 5px;
      overflow: hidden;
      position: relative;
    }

    .hud-hull-fill {
      height: 100%;
      background: linear-gradient(90deg, #00ff00, #00cc00);
      transition: width 0.5s ease, background 0.3s ease;
    }

    .hud-hull-fill.damaged {
      background: linear-gradient(90deg, #ffaa00, #ff8800);
    }

    .hud-hull-fill.critical {
      background: linear-gradient(90deg, #ff0000, #cc0000);
    }

    .hud-initiative {
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
      text-align: center;
      font-size: 14px;
    }

    .initiative-label {
      opacity: 0.8;
      margin-right: 8px;
    }

    .initiative-value {
      font-weight: bold;
      color: #00ff00;
    }

    .crew-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
      padding: 5px 0;
      transition: opacity 0.2s;
    }

    .crew-panel-header:hover {
      opacity: 0.8;
    }

    .crew-panel-header h3 {
      margin: 0;
    }

    .collapse-icon {
      font-size: 16px;
      transition: transform 0.3s;
    }

    .crew-panel-header.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }

    .crew-panel-content {
      max-height: 500px;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      opacity: 1;
    }

    .crew-panel-content.collapsed {
      max-height: 0;
      opacity: 0;
    }

    #crew-panel {
      margin-top: 10px;
    }

    .crew-role {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      margin-bottom: 5px;
      font-size: 14px;
    }

    .role-name {
      font-weight: bold;
      min-width: 80px;
      color: #00ff00;
    }

    .crew-name {
      flex: 1;
    }

    .turret-assignment {
      padding: 3px 8px;
      background: rgba(0, 255, 0, 0.2);
      border: 1px solid rgba(0, 255, 0, 0.5);
      border-radius: 3px;
      font-size: 12px;
      color: #00ff00;
    }

    .gunner-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .gunner-controls .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .gunner-controls .control-group label {
      font-size: 14px;
      font-weight: bold;
      color: #00ff00;
    }

    .gunner-controls select {
      width: 100%;
    }

    .fire-button {
      grid-column: span 2;
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      background: linear-gradient(135deg, #ff4444, #cc0000);
      border: 2px solid #ff6666;
      color: #fff;
      cursor: pointer;
      transition: all 0.3s;
    }

    .fire-button:hover:not(:disabled) {
      background: linear-gradient(135deg, #ff6666, #ff0000);
      box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
      transform: scale(1.02);
    }

    .fire-button:disabled {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.3);
      cursor: not-allowed;
      opacity: 0.5;
    }

    .turn-management {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }

    .turn-timer-display {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
    }

    .timer-label {
      font-size: 14px;
      opacity: 0.8;
    }

    .timer-value {
      font-size: 20px;
      font-weight: bold;
      color: #00ff00;
      min-width: 50px;
    }

    .timer-value.warning {
      color: #ffaa00;
    }

    .timer-value.critical {
      color: #ff0000;
      animation: pulse 0.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .turn-buttons {
      display: flex;
      gap: 10px;
    }

    .action-button {
      padding: 12px 20px;
      font-size: 14px;
      font-weight: bold;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.3);
      color: #fff;
      cursor: pointer;
      border-radius: 5px;
      transition: all 0.3s;
    }

    .action-button:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: rgba(255, 255, 255, 0.5);
    }

    .action-button.primary {
      background: linear-gradient(135deg, #00ff00, #00cc00);
      border-color: #00ff00;
      color: #000;
    }

    .action-button.primary:hover {
      background: linear-gradient(135deg, #00ff44, #00ff00);
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.5);
    }

    .combat-log {
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
      font-size: 13px;
      line-height: 1.6;
    }

    .log-entry {
      padding: 5px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .log-entry:last-child {
      border-bottom: none;
    }

    .log-entry.hit {
      color: #ff4444;
    }

    .log-entry.miss {
      color: #888;
    }

    .log-entry.critical {
      color: #ffaa00;
      font-weight: bold;
    }

    .log-entry.system {
      color: #00ff00;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>‚öîÔ∏è Traveller Combat VTT</h1>
      <div class="stage">STAGE 8.6: SPACE COMBAT SHIP SELECTION</div>
    </div>

    <!-- Stage 8.6: Ship Selection Screen -->
    <div id="ship-selection-screen">
      <div class="card">
        <h2>üöÄ Select Your Spacecraft</h2>

        <div class="ship-selection-grid">
          <div class="ship-option" id="ship-option-scout" data-ship="scout">
            <div class="ship-option-header">‚ö° Scout</div>
            <div class="ship-option-type">Type-S Scout/Courier</div>
            <div class="ship-option-stats">
              <div>Hull: <strong>20</strong></div>
              <div>Armour: <strong>4</strong></div>
              <div>Thrust: <strong>2</strong></div>
              <div>Turrets: <strong>1</strong></div>
            </div>
            <div class="ship-option-description">
              Fast exploration vessel with triple turret (pulse laser, sandcaster, missiles)
            </div>
          </div>

          <div class="ship-option" id="ship-option-free_trader" data-ship="free_trader">
            <div class="ship-option-header">üì¶ Free Trader</div>
            <div class="ship-option-type">Type-A Free Trader</div>
            <div class="ship-option-stats">
              <div>Hull: <strong>30</strong></div>
              <div>Armour: <strong>2</strong></div>
              <div>Thrust: <strong>1</strong></div>
              <div>Turrets: <strong>2</strong></div>
            </div>
            <div class="ship-option-description">
              Versatile merchant vessel with dual beam laser turrets
            </div>
          </div>
        </div>

        <div class="range-selection">
          <label for="range-select">Starting Range:</label>
          <select id="range-select">
            <option value="Adjacent">Adjacent</option>
            <option value="Close">Close</option>
            <option value="Short" selected>Short</option>
            <option value="Medium">Medium</option>
            <option value="Long">Long</option>
            <option value="Very Long">Very Long</option>
            <option value="Distant">Distant</option>
          </select>
        </div>

        <div class="ready-section">
          <div class="ready-indicators">
            <div class="ready-indicator waiting" id="player-ready-indicator">
              ‚è± Select ship and range
            </div>
            <div class="ready-indicator waiting" id="opponent-ready-indicator">
              ‚è± Waiting for opponent...
            </div>
          </div>
          <button id="ready-button" disabled>Ready</button>
        </div>

        <div id="ready-status"></div>
      </div>
    </div>

    <!-- Stage 8.7: Space Combat HUD -->
    <div id="space-combat-hud" style="display: none;">
      <div class="header">
        <h1>üöÄ Traveller Space Combat</h1>
        <div class="stage">STAGE 8.7: SPACE COMBAT HUD</div>
      </div>

      <!-- Ship Status HUD -->
      <div class="card">
        <div class="hud-top">
          <div class="hud-ship-info">
            <div class="hud-ship-name" id="ship-name">Scout</div>
            <div class="hud-ship-type">Type-S Scout/Courier</div>
          </div>
          <div class="hud-stats">
            <div class="hud-stat">
              <span class="hud-stat-label">Armour:</span>
              <span class="hud-stat-value" id="ship-armour">4</span>
            </div>
            <div class="hud-stat">
              <span class="hud-stat-label">Range:</span>
              <span class="hud-stat-value" id="current-range">Short</span>
            </div>
            <div class="hud-stat">
              <span class="hud-stat-label">Round:</span>
              <span class="hud-stat-value" id="round-counter">1</span>
            </div>
          </div>
        </div>

        <div class="hud-hull-section">
          <div class="hud-hull-label">
            Hull: <span id="hull-current">20</span> / <span id="hull-max">20</span>
          </div>
          <div class="hud-hull-bar">
            <div class="hud-hull-fill" id="hull-bar-fill" style="width: 100%;"></div>
          </div>
        </div>

        <div class="hud-initiative" id="initiative-display">
          <span class="initiative-label">Initiative:</span>
          <span class="initiative-value" id="initiative-value">Calculating...</span>
        </div>
      </div>

      <!-- Crew Panel (Collapsible) -->
      <div class="card">
        <div class="crew-panel-header" id="crew-panel-toggle">
          <h3>üë• Crew</h3>
          <span class="collapse-icon">‚ñº</span>
        </div>
        <div class="crew-panel-content" id="crew-panel-content">
          <div id="crew-panel">
            <div class="crew-role">
              <span class="role-name">Pilot:</span>
              <span class="crew-name">Miller (Skill +2)</span>
            </div>
            <div class="crew-role">
              <span class="role-name">Gunner:</span>
              <span class="crew-name">Chen (Skill +1)</span>
              <span class="turret-assignment">Turret 1</span>
            </div>
            <div class="crew-role">
              <span class="role-name">Engineer:</span>
              <span class="crew-name">Rodriguez (Skill +1)</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Gunner Actions -->
      <div class="card">
        <h3>üéØ Gunner Actions</h3>
        <div class="gunner-controls">
          <div class="control-group">
            <label for="turret-select">Turret:</label>
            <select id="turret-select">
              <option value="0">Turret 1 (Triple)</option>
            </select>
          </div>
          <div class="control-group">
            <label for="target-select">Target:</label>
            <select id="target-select">
              <option value="opponent">Enemy Ship</option>
            </select>
          </div>
          <div class="control-group">
            <label for="weapon-select">Weapon:</label>
            <select id="weapon-select">
              <option value="0">Pulse Laser (2d6)</option>
              <option value="1">Sandcaster (Defense)</option>
              <option value="2">Missiles (4d6, 6 shots)</option>
            </select>
          </div>
          <button id="fire-button" class="fire-button" disabled>üî• FIRE!</button>
        </div>
      </div>

      <!-- Turn Management -->
      <div class="card">
        <div class="turn-management">
          <div class="turn-timer-display">
            <span class="timer-label">Turn Timer:</span>
            <span class="timer-value" id="turn-timer">30s</span>
          </div>
          <div class="turn-buttons">
            <button id="use-default-button" class="action-button">‚ö° Use Default</button>
            <button id="end-turn-button" class="action-button primary">‚úÖ End Turn</button>
          </div>
        </div>
      </div>

      <!-- Combat Log -->
      <div class="card">
        <h3>üìú Combat Log</h3>
        <div class="combat-log" id="combat-log">
          <div class="log-entry">Round 1 begins!</div>
          <div class="log-entry">Combat started at Short range</div>
        </div>
      </div>
    </div>

    <!-- Personal Combat Screen (hidden initially for now) -->
    <div id="personal-combat-screen" style="display: none;">
    <div class="header">
      <h1>‚öîÔ∏è Traveller Combat VTT</h1>
      <div class="stage">STAGE 4: COMBAT ROUNDS & TURNS</div>
    </div>
    
    <div class="card">
      <div class="status">
        <div class="status-dot" id="statusDot"></div>
        <div id="connectionInfo">Connecting...</div>
      </div>

      <!-- Stage 4: Turn indicator -->
      <div class="turn-indicator waiting" id="turnIndicator">
        <div id="turnStatus">‚è≥ Waiting for game to start...</div>
        <div class="round-display" id="roundDisplay">Click "Start Game" when both players are connected</div>
      </div>

      <div class="instructions">
        <strong>üìã Mongoose Traveller 2e Rules:</strong><br>
        Attack: 2d6 + Pilot Skill + Range DM - Dodge DM ‚â• 8<br>
        Damage: 2d6 - Armor (minimum 0)
      </div>
      
      <div class="combat-controls">
        <div class="control-group">
          <label id="attackerLabel">Attacker</label>
          <select id="attackerSelect">
            <option value="scout">Scout (Skill +2, Armor 2, Hull 10)</option>
            <option value="corsair">Corsair (Skill +1, Armor 4, Hull 15)</option>
          </select>
        </div>

        <div class="control-group">
          <label id="targetLabel">Target</label>
          <select id="targetSelect">
            <option value="corsair">Corsair (Skill +1, Armor 4, Hull 15)</option>
            <option value="scout">Scout (Skill +2, Armor 2, Hull 10)</option>
          </select>
        </div>

        <!-- Stage 5: Weapon selector -->
        <div class="control-group">
          <label>Weapon</label>
          <select id="weaponSelect">
            <option value="pulseLaser">Pulse Laser (2d6)</option>
          </select>
        </div>

        <div class="control-group">
          <label>Range</label>
          <select id="rangeSelect">
            <option value="adjacent">Adjacent (+2)</option>
            <option value="close">Close (+1)</option>
            <option value="medium" selected>Medium (0)</option>
            <option value="long">Long (-2)</option>
            <option value="veryLong">Very Long (-4)</option>
          </select>
        </div>

        <div class="control-group">
          <label>Target Dodge</label>
          <select id="dodgeSelect">
            <option value="none" selected>None (0)</option>
            <option value="partial">Partial (-1 to attack)</option>
            <option value="full">Full (-2 to attack)</option>
          </select>
        </div>
      </div>

      <!-- Stage 4: Updated button layout with Start Game and End Turn -->
      <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <button id="startGameBtn" class="start-game" disabled style="flex: 1;">üéÆ Start Game</button>
        <button id="resetBtn" disabled style="flex: 0; min-width: 120px; background: #ff6b6b;">üîÑ Reset Game</button>
      </div>

      <div style="display: flex; gap: 10px;">
        <button id="attackBtn" disabled style="flex: 1;">‚öîÔ∏è Attack!</button>
        <button id="repairBtn" class="repair-button" disabled style="flex: 1;">üîß Repair</button>
        <button id="endTurnBtn" class="end-turn" disabled style="flex: 1;">‚û°Ô∏è End Turn</button>
      </div>
    </div>
    
    <div class="card">
      <h2>üìä Ship Stats</h2>
      <div class="ship-stats">
        <div class="ship-card" id="scoutStats">
          <div class="ship-name">üöÄ Scout</div>
          <div class="ship-stat"><span>Hull:</span><span id="scoutHull">10 / 10</span></div>
          <div class="ship-stat"><span>Armor:</span><span>2</span></div>
          <div class="ship-stat"><span>Pilot Skill:</span><span>+2</span></div>
          <div class="ship-stat"><span>Pulse Laser:</span><span>2d6, Unlimited</span></div>
          <div class="ship-stat"><span>Missiles:</span><span id="scoutMissiles">6 / 6</span></div>
        </div>

        <div class="ship-card" id="corsairStats">
          <div class="ship-name">üè¥‚Äç‚ò†Ô∏è Corsair</div>
          <div class="ship-stat"><span>Hull:</span><span id="corsairHull">15 / 15</span></div>
          <div class="ship-stat"><span>Armor:</span><span>4</span></div>
          <div class="ship-stat"><span>Pilot Skill:</span><span>+1</span></div>
          <div class="ship-stat"><span>Beam Laser:</span><span>3d6, Close-Med</span></div>
          <div class="ship-stat"><span>Missiles:</span><span id="corsairMissiles">6 / 6</span></div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üó∫Ô∏è Tactical Grid</h2>
      <div class="grid-container">
        <svg id="hexGrid" width="600" height="600" viewBox="0 0 600 600">
          <!-- Hex grid will be rendered here by JavaScript -->
        </svg>
        <div class="grid-info">
          <div>Range: <span id="rangeDisplay">-</span></div>
          <div>Your Movement: <span id="movementDisplay">-</span> hexes</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üë• Crew Roster</h2>
      <div class="crew-roster">
        <div class="crew-section">
          <div class="crew-ship-name">üöÄ Scout Crew</div>
          <div class="crew-member" id="scoutPilot">
            <div class="crew-role">üë®‚Äç‚úàÔ∏è Pilot:</div>
            <div class="crew-name">Lt. Sarah Chen</div>
            <div class="crew-skills">Pilot +2</div>
            <div class="crew-health">HP: <span id="scoutPilotHP">10/10</span></div>
          </div>
          <div class="crew-member" id="scoutGunner">
            <div class="crew-role">üéØ Gunner:</div>
            <div class="crew-name">Cpl. James Martinez</div>
            <div class="crew-skills">Gunner +2</div>
            <div class="crew-health">HP: <span id="scoutGunnerHP">10/10</span></div>
          </div>
          <div class="crew-member" id="scoutEngineer">
            <div class="crew-role">üîß Engineer:</div>
            <div class="crew-name">Tech. Emily Wong</div>
            <div class="crew-skills">Engineering +1</div>
            <div class="crew-health">HP: <span id="scoutEngineerHP">10/10</span></div>
          </div>
        </div>

        <div class="crew-section">
          <div class="crew-ship-name">üè¥‚Äç‚ò†Ô∏è Corsair Crew</div>
          <div class="crew-member" id="corsairPilot">
            <div class="crew-role">üë®‚Äç‚úàÔ∏è Pilot:</div>
            <div class="crew-name">Pirate Kane</div>
            <div class="crew-skills">Pilot +1</div>
            <div class="crew-health">HP: <span id="corsairPilotHP">10/10</span></div>
          </div>
          <div class="crew-member" id="corsairGunner">
            <div class="crew-role">üéØ Gunner:</div>
            <div class="crew-name">Pirate Vex</div>
            <div class="crew-skills">Gunner +1</div>
            <div class="crew-health">HP: <span id="corsairGunnerHP">10/10</span></div>
          </div>
          <div class="crew-member" id="corsairEngineer">
            <div class="crew-role">üîß Engineer:</div>
            <div class="crew-name">Pirate Rusty</div>
            <div class="crew-skills">Engineering +0</div>
            <div class="crew-health">HP: <span id="corsairEngineerHP">10/10</span></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üìú Combat Log</h2>
      <div class="combat-log" id="combatLog">
        <div class="log-entry" style="border-left-color: #ffa500;">
          <div class="log-header">‚ö° System Ready</div>
          <div class="log-details">Select ships and click "Attack!" to begin combat simulation.</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Test Mode Button (fixed position bottom-right) -->
  <div class="test-mode">
    <button id="testModeBtn" disabled>üß™ Run Tests</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();

    // Stage 3: Track player ID and assigned ship
    let myPlayerId = null;
    let myShip = null;
    let myRole = null;
    let gameState = {
      assignments: { scout: null, corsair: null },
      currentRound: 0,
      currentTurn: null,
      initiative: { scout: null, corsair: null }
    };

    const statusDot = document.getElementById('statusDot');
    const connectionInfo = document.getElementById('connectionInfo');
    const attackBtn = document.getElementById('attackBtn');
    const resetBtn = document.getElementById('resetBtn');
    const testModeBtn = document.getElementById('testModeBtn');
    const combatLog = document.getElementById('combatLog');

    // Stage 4: Turn system UI elements
    const startGameBtn = document.getElementById('startGameBtn');
    const endTurnBtn = document.getElementById('endTurnBtn');
    const repairBtn = document.getElementById('repairBtn');  // Stage 6: Repair button
    const turnIndicator = document.getElementById('turnIndicator');
    const turnStatus = document.getElementById('turnStatus');
    const roundDisplay = document.getElementById('roundDisplay');

    const attackerSelect = document.getElementById('attackerSelect');
    const targetSelect = document.getElementById('targetSelect');
    const rangeSelect = document.getElementById('rangeSelect');
    const dodgeSelect = document.getElementById('dodgeSelect');
    const attackerLabel = document.getElementById('attackerLabel');
    const targetLabel = document.getElementById('targetLabel');

    // Stage 5: Weapon selection and ammo display
    const weaponSelect = document.getElementById('weaponSelect');
    const scoutMissiles = document.getElementById('scoutMissiles');
    const corsairMissiles = document.getElementById('corsairMissiles');
    const scoutHull = document.getElementById('scoutHull');
    const corsairHull = document.getElementById('corsairHull');

    // Stage 7: Hex grid elements
    const hexGrid = document.getElementById('hexGrid');
    const rangeDisplay = document.getElementById('rangeDisplay');
    const movementDisplay = document.getElementById('movementDisplay');

    // Stage 7: Grid state
    const GRID_SIZE = 10;
    const HEX_SIZE = 25;
    const shipPositions = { scout: { q: 2, r: 2 }, corsair: { q: 7, r: 7 } };

    // Stage 7: Hex grid functions
    function hexToPixel(q, r) {
      const x = HEX_SIZE * (3/2 * q) + 50;
      const y = HEX_SIZE * (Math.sqrt(3)/2 * q + Math.sqrt(3) * r) + 50;
      return { x, y };
    }

    function pixelToHex(x, y) {
      const q = Math.round((2/3 * (x - 50)) / HEX_SIZE);
      const r = Math.round((-(x - 50)/3 + Math.sqrt(3)/3 * (y - 50)) / HEX_SIZE);
      return { q, r };
    }

    function hexDistance(pos1, pos2) {
      const x1 = pos1.q, z1 = pos1.r, y1 = -x1 - z1;
      const x2 = pos2.q, z2 = pos2.r, y2 = -x2 - z2;
      return (Math.abs(x1 - x2) + Math.abs(y1 - y2) + Math.abs(z1 - z2)) / 2;
    }

    function rangeFromDistance(distance) {
      if (distance <= 1) return 'Adjacent';
      if (distance <= 3) return 'Close';
      if (distance <= 5) return 'Medium';
      if (distance <= 7) return 'Long';
      return 'Very Long';
    }

    function drawHex(q, r, className = 'hex') {
      const pos = hexToPixel(q, r);
      const points = [];
      for (let i = 0; i < 6; i++) {
        const angle = Math.PI / 3 * i;
        const hx = pos.x + HEX_SIZE * Math.cos(angle);
        const hy = pos.y + HEX_SIZE * Math.sin(angle);
        points.push(`${hx},${hy}`);
      }

      const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
      polygon.setAttribute('points', points.join(' '));
      polygon.setAttribute('class', className);
      polygon.setAttribute('data-q', q);
      polygon.setAttribute('data-r', r);
      return polygon;
    }

    function drawShip(q, r, shipName) {
      const pos = hexToPixel(q, r);
      const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      circle.setAttribute('cx', pos.x);
      circle.setAttribute('cy', pos.y);
      circle.setAttribute('r', HEX_SIZE * 0.6);
      circle.setAttribute('class', `ship-marker ${shipName}`);
      circle.setAttribute('data-ship', shipName);

      const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
      text.setAttribute('x', pos.x);
      text.setAttribute('y', pos.y);
      text.setAttribute('text-anchor', 'middle');
      text.setAttribute('dominant-baseline', 'middle');
      text.setAttribute('fill', 'white');
      text.setAttribute('font-size', '12');
      text.setAttribute('font-weight', 'bold');
      text.setAttribute('pointer-events', 'none');
      text.textContent = shipName === 'scout' ? 'üöÄ' : 'üè¥‚Äç‚ò†Ô∏è';

      const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      g.appendChild(circle);
      g.appendChild(text);
      return g;
    }

    function renderGrid() {
      hexGrid.innerHTML = '';

      // Draw hexes
      for (let q = 0; q < GRID_SIZE; q++) {
        for (let r = 0; r < GRID_SIZE; r++) {
          const hex = drawHex(q, r);
          hex.addEventListener('click', () => handleHexClick(q, r));
          hexGrid.appendChild(hex);
        }
      }

      // Draw ships
      hexGrid.appendChild(drawShip(shipPositions.scout.q, shipPositions.scout.r, 'scout'));
      hexGrid.appendChild(drawShip(shipPositions.corsair.q, shipPositions.corsair.r, 'corsair'));

      updateRangeDisplay();
    }

    function updateRangeDisplay() {
      const distance = hexDistance(shipPositions.scout, shipPositions.corsair);
      const range = rangeFromDistance(distance);
      rangeDisplay.textContent = `${range} (${Math.floor(distance)} hexes)`;

      if (myShip) {
        const movement = myShip === 'scout' ? 3 : 2;
        movementDisplay.textContent = movement;
      }
    }

    function handleHexClick(q, r) {
      if (!myShip) return;
      console.log(`[GRID] Clicked hex (${q}, ${r})`);

      socket.emit('moveShip', {
        ship: myShip,
        to: { q, r }
      });
    }

    socket.on('connect', () => {
      console.log('[SOCKET] Connected');
      statusDot.className = 'status-dot connected';
      resetBtn.disabled = false;
      testModeBtn.disabled = false;
      startGameBtn.disabled = false;
      // Attack and End Turn buttons controlled by turn state
      updateTurnUI();

      // Stage 7: Render hex grid
      renderGrid();
    });

    // Stage 3: Receive ship assignment
    socket.on('welcome', (data) => {
      myPlayerId = data.playerId;
      myShip = data.assignedShip;
      myRole = data.role;

      console.log(`[ASSIGN] You are Player ${myPlayerId}`);
      console.log(`[ASSIGN] Your ship: ${myShip || 'none (spectator)'}`);

      const roleText = myShip ? `${myShip.toUpperCase()} Player` : 'Spectator';
      connectionInfo.textContent = `${roleText} (Player ${myPlayerId}) ‚Ä¢ ${data.totalPlayers} connected`;

      // Update controls based on assignment (will implement in next step)
      updateControlsForAssignment();
    });

    // Stage 3: Handle new player joining
    socket.on('playerJoined', (data) => {
      console.log(`[PLAYER] Player ${data.playerId} joined as ${data.ship || 'spectator'}`);
      gameState.assignments = data.assignments;
      connectionInfo.textContent = connectionInfo.textContent.replace(/\d+ connected/, `${data.totalPlayers} connected`);
    });

    // Stage 3: Handle player leaving
    socket.on('playerLeft', (data) => {
      console.log(`[PLAYER] Player ${data.playerId} (${data.ship || 'spectator'}) left`);
      gameState.assignments = data.assignments;
      connectionInfo.textContent = connectionInfo.textContent.replace(/\d+ connected/, `${data.totalPlayers} connected`);
    });

    // Stage 4: Receive current game state (UPDATED with turn info)
    socket.on('gameState', (data) => {
      console.log('[STATE] Game state received:', data);
      gameState.assignments = data.assignments;
      gameState.currentRound = data.currentRound || 0;
      gameState.currentTurn = data.currentTurn || null;
      gameState.initiative = data.initiative || { scout: null, corsair: null };

      if (data.shipStates) {
        updateShipDisplay(data.shipStates);
      }

      updateTurnUI();
    });

    // Stage 3: Receive ship state updates (hull changes)
    socket.on('shipStateUpdate', (data) => {
      console.log('[STATE] Ship state update:', data.ships);
      updateShipDisplay(data.ships);

      // Stage 7: Update ship positions on grid
      if (data.ships.scout && data.ships.scout.position) {
        shipPositions.scout = data.ships.scout.position;
      }
      if (data.ships.corsair && data.ships.corsair.position) {
        shipPositions.corsair = data.ships.corsair.position;
      }
      renderGrid();
    });

    // Update UI to show current ship hull values
    // Stage 5: Also update ammo displays
    function updateShipDisplay(ships) {
      // Update attacker select options
      const scoutOption = attackerSelect.querySelector('option[value="scout"]');
      const corsairOptionAttacker = attackerSelect.querySelector('option[value="corsair"]');

      if (scoutOption) {
        scoutOption.textContent = `Scout (Skill +2, Armor 2, Hull ${ships.scout.hull}/${ships.scout.maxHull})`;
      }
      if (corsairOptionAttacker) {
        corsairOptionAttacker.textContent = `Corsair (Skill +1, Armor 4, Hull ${ships.corsair.hull}/${ships.corsair.maxHull})`;
      }

      // Update target select options
      const scoutOptionTarget = targetSelect.querySelector('option[value="scout"]');
      const corsairOptionTarget = targetSelect.querySelector('option[value="corsair"]');

      if (scoutOptionTarget) {
        scoutOptionTarget.textContent = `Scout (Skill +2, Armor 2, Hull ${ships.scout.hull}/${ships.scout.maxHull})`;
      }
      if (corsairOptionTarget) {
        corsairOptionTarget.textContent = `Corsair (Skill +1, Armor 4, Hull ${ships.corsair.hull}/${ships.corsair.maxHull})`;
      }

      // Stage 5: Update ship stats cards (hull + ammo)
      if (scoutHull) {
        scoutHull.textContent = `${ships.scout.hull} / ${ships.scout.maxHull}`;
      }
      if (corsairHull) {
        corsairHull.textContent = `${ships.corsair.hull} / ${ships.corsair.maxHull}`;
      }

      // Stage 5: Update ammo displays
      if (ships.scout.ammo && scoutMissiles) {
        const missiles = ships.scout.ammo.missiles !== undefined ? ships.scout.ammo.missiles : 6;
        scoutMissiles.textContent = `${missiles} / 6`;
      }
      if (ships.corsair.ammo && corsairMissiles) {
        const missiles = ships.corsair.ammo.missiles !== undefined ? ships.corsair.ammo.missiles : 6;
        corsairMissiles.textContent = `${missiles} / 6`;
      }

      console.log(`[UI] Updated ship displays - Scout: ${ships.scout.hull}/${ships.scout.maxHull}, Corsair: ${ships.corsair.hull}/${ships.corsair.maxHull}`);
    }

    // Stage 4: Handle game reset event (UPDATED with turn state)
    socket.on('gameReset', (data) => {
      console.log('[RESET] Game reset by Player', data.initiatedBy);
      gameState.currentRound = data.currentRound || 0;
      gameState.currentTurn = data.currentTurn || null;
      addLog('üîÑ Game Reset', 'info', data.message);
      updateTurnUI();
    });

    // Stage 4: Handle round start event
    socket.on('roundStart', (data) => {
      console.log('[ROUND] Round started:', data);
      gameState.currentRound = data.round;
      gameState.currentTurn = data.currentTurn;
      gameState.initiative = data.initiative;

      const initScout = data.initiative.scout;
      const initCorsair = data.initiative.corsair;

      addLog(
        `üé≤ Round ${data.round} Begins!`,
        'info',
        `Initiative - Scout: ${initScout.total} (${initScout.roll.dice.join('+')}) | Corsair: ${initCorsair.total} (${initCorsair.roll.dice.join('+')}) | ${data.currentTurn.toUpperCase()} goes first!`
      );

      updateTurnUI();
    });

    // Stage 4: Handle turn change event
    socket.on('turnChange', (data) => {
      console.log('[TURN] Turn changed:', data);
      gameState.currentRound = data.round;
      gameState.currentTurn = data.currentTurn;

      addLog(`‚û°Ô∏è Turn: ${data.currentTurn.toUpperCase()}`, 'info', data.message);
      updateTurnUI();
    });

    // Stage 4: Handle game errors
    socket.on('gameError', (data) => {
      console.error('[ERROR]', data.message);
      alert(data.message);
    });

    // Stage 6: Handle repair result
    socket.on('repairResult', (data) => {
      console.log('[REPAIR] Repair completed:', data);
      addLog(
        `üîß ${data.ship.toUpperCase()} Repaired`,
        'success',
        `${data.engineer} repaired ${data.hullRepaired} HP (New Hull: ${data.newHull})`
      );
    });

    // Stage 6: Handle repair error
    socket.on('repairError', (data) => {
      console.error('[REPAIR ERROR]', data.message);
      alert(data.message);
    });

    // Stage 7: Handle movement result
    socket.on('moveResult', (data) => {
      console.log('[MOVE] Movement completed:', data);
      addLog(
        `üöÄ ${data.ship.toUpperCase()} Moved`,
        'info',
        `Moved ${Math.floor(data.distance)} hexes. New range: ${data.newRange}`
      );
    });

    // Stage 7: Handle movement error
    socket.on('moveError', (data) => {
      console.error('[MOVE ERROR]', data.message);
      alert(data.message);
    });

    socket.on('disconnect', () => {
      console.log('[SOCKET] Disconnected');
      statusDot.className = 'status-dot disconnected';
      connectionInfo.textContent = 'Disconnected';
      attackBtn.disabled = true;
      resetBtn.disabled = true;
      testModeBtn.disabled = true;
    });

    // Helper: Add log entry
    function addLog(header, type = 'info', details = '') {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.style.borderLeftColor = type === 'info' ? '#ffa500' : '';

      let html = `<div class="log-header">${header}</div>`;
      if (details) {
        html += `<div class="log-details">${details}</div>`;
      }

      entry.innerHTML = html;
      combatLog.appendChild(entry);
      combatLog.scrollTop = combatLog.scrollHeight;
    }
    
    socket.on('combatResult', (data) => {
      console.log('[COMBAT] Result received:', data);
      displayCombatResult(data);
    });

    // Stage 3: Handle combat errors (unauthorized attacks)
    socket.on('combatError', (data) => {
      console.error('[COMBAT] Error:', data.message);
      alert(`Combat Error: ${data.message}`);
    });

    // Stage 4: Update turn UI based on game state
    function updateTurnUI() {
      const isMyTurn = gameState.currentTurn === myShip;
      const gameStarted = gameState.currentRound > 0;

      if (!gameStarted) {
        // Game hasn't started yet
        turnIndicator.className = 'turn-indicator waiting';
        turnStatus.textContent = '‚è≥ Waiting for game to start...';
        roundDisplay.textContent = 'Click "Start Game" when both players are connected';
        attackBtn.disabled = true;
        endTurnBtn.disabled = true;
        startGameBtn.disabled = myShip === null; // Can't start if spectator
      } else if (isMyTurn) {
        // It's your turn
        turnIndicator.className = 'turn-indicator your-turn';
        turnStatus.textContent = '‚úÖ YOUR TURN';
        roundDisplay.textContent = `Round ${gameState.currentRound}`;
        attackBtn.disabled = myShip === null; // Only disable if spectator
        repairBtn.disabled = myShip === null; // Stage 6: Enable repair on your turn
        endTurnBtn.disabled = false;
        startGameBtn.disabled = true;
      } else {
        // Opponent's turn
        const opponentShip = myShip === 'scout' ? 'Corsair' : 'Scout';
        turnIndicator.className = 'turn-indicator opponent-turn';
        turnStatus.textContent = `‚è∏Ô∏è ${opponentShip.toUpperCase()}'S TURN`;
        roundDisplay.textContent = `Round ${gameState.currentRound} - Waiting...`;
        attackBtn.disabled = true;
        repairBtn.disabled = true; // Stage 6: Disable repair on opponent's turn
        endTurnBtn.disabled = true;
        startGameBtn.disabled = true;
      }

      console.log(`[UI] Turn UI updated - Round: ${gameState.currentRound}, Turn: ${gameState.currentTurn}, My Ship: ${myShip}, My Turn: ${isMyTurn}`);
    }

    // Stage 5: Populate weapon selector based on ship
    function updateWeaponSelector(shipName) {
      weaponSelect.innerHTML = '';

      const weapons = {
        scout: [
          { id: 'pulseLaser', name: 'Pulse Laser', damage: '2d6', ammo: null },
          { id: 'missiles', name: 'Missiles', damage: '4d6', ammo: 6 }
        ],
        corsair: [
          { id: 'beamLaser', name: 'Beam Laser', damage: '3d6', ammo: null },
          { id: 'missiles', name: 'Missiles', damage: '4d6', ammo: 6 }
        ]
      };

      const shipWeapons = weapons[shipName] || [];
      shipWeapons.forEach(weapon => {
        const option = document.createElement('option');
        option.value = weapon.id;
        const ammoText = weapon.ammo ? ` (${weapon.ammo} shots)` : ' (Unlimited)';
        option.textContent = `${weapon.name} ${weapon.damage}${ammoText}`;
        weaponSelect.appendChild(option);
      });

      console.log(`[WEAPONS] Populated ${shipWeapons.length} weapons for ${shipName}`);
    }

    // Stage 3: Update controls based on ship assignment
    // Stage 5: Also populate weapon selector
    function updateControlsForAssignment() {
      if (!myShip) {
        // Spectator mode - disable attack button
        attackBtn.disabled = true;
        attackBtn.textContent = 'üîí Spectator Mode';
        attackerSelect.disabled = true;
        weaponSelect.disabled = true;
        attackerLabel.textContent = 'Attacker (Spectating)';
        targetLabel.textContent = 'Target (Spectating)';
        return;
      }

      // Set attacker to your ship and lock it
      attackerSelect.value = myShip;
      attackerSelect.disabled = true; // Can't change attacker

      // Set target to the other ship
      const otherShip = myShip === 'scout' ? 'corsair' : 'scout';
      targetSelect.value = otherShip;

      // Stage 5: Populate weapon selector
      updateWeaponSelector(myShip);

      // Update labels with visual distinction
      const myShipName = myShip.charAt(0).toUpperCase() + myShip.slice(1);
      const opponentShipName = otherShip.charAt(0).toUpperCase() + otherShip.slice(1);

      attackerLabel.textContent = `YOUR SHIP (${myShipName})`;
      attackerLabel.className = 'your-ship';

      targetLabel.textContent = `OPPONENT (${opponentShipName})`;
      targetLabel.className = 'opponent-ship';

      console.log(`[CONTROLS] Locked attacker to ${myShip}, target set to ${otherShip}`);
      console.log(`[VISUALS] Applied ship ownership labels`);
    }

    attackBtn.addEventListener('click', () => {
      const attacker = attackerSelect.value;
      const target = targetSelect.value;
      const range = rangeSelect.value;
      const dodge = dodgeSelect.value;
      const weapon = weaponSelect.value;  // Stage 5: Get selected weapon

      if (attacker === target) {
        alert('Attacker and target must be different!');
        return;
      }

      console.log(`[COMBAT] Initiating combat with ${weapon}`);
      socket.emit('combat', {
        attacker,
        target,
        range,
        dodge,
        weapon,  // Stage 5: Send weapon selection
        seed: Date.now()
      });
    });

    // Stage 3: Reset game button
    resetBtn.addEventListener('click', () => {
      if (confirm('Reset game? This will restore both ships to full hull and reset rounds.')) {
        console.log('[RESET] Requesting game reset');
        socket.emit('resetGame');
      }
    });

    // Stage 4: Start game button
    startGameBtn.addEventListener('click', () => {
      console.log('[START] Requesting game start');
      socket.emit('startGame');
    });

    // Stage 4: End turn button
    endTurnBtn.addEventListener('click', () => {
      console.log('[TURN] Ending turn');
      socket.emit('endTurn');
    });

    // Stage 6: Repair button
    repairBtn.addEventListener('click', () => {
      if (!myShip) {
        alert('You must be assigned a ship to repair!');
        return;
      }
      console.log('[REPAIR] Requesting engineer repair');
      socket.emit('engineerRepair', {
        ship: myShip,
        seed: Date.now()
      });
    });

    // TEST MODE - Run all functional tests
    testModeBtn.addEventListener('click', async () => {
      console.log('[TEST] Starting test suite...');
      addTestLog('üß™ Running Stage 2 Functional Tests...');
      
      testModeBtn.disabled = true;
      testModeBtn.textContent = '‚è≥ Testing...';
      
      const tests = [
        testSocketConnection,
        testCombatMathBasic,
        testCombatMathHit,
        testCombatMathMiss,
        testRangeModifiers,
        testDodgeModifiers,
        testMultiTabSync
      ];
      
      let passed = 0;
      let failed = 0;
      
      for (const test of tests) {
        try {
          await test();
          passed++;
        } catch (error) {
          failed++;
          console.error('[TEST] Failed:', error);
        }
        await sleep(500); // Pause between tests
      }
      
      const allPassed = failed === 0;
      addTestLog(
        allPassed ? '‚úÖ All Tests Passed' : `‚ö†Ô∏è ${passed}/${passed + failed} Tests Passed`,
        allPassed ? 'test-pass' : 'test-fail',
        `Passed: ${passed}, Failed: ${failed}`
      );
      
      testModeBtn.disabled = false;
      testModeBtn.textContent = allPassed ? '‚úÖ Tests Passed' : '‚ö†Ô∏è Some Failed';
      
      setTimeout(() => {
        testModeBtn.textContent = 'üß™ Run Tests';
      }, 3000);
    });
    
    // Test 1: Socket connection
    async function testSocketConnection() {
      addTestLog('Test 1: Socket Connection', 'test');

      if (!socket.connected) {
        throw new Error('Socket not connected');
      }

      if (myPlayerId === null) {
        throw new Error('Player ID not assigned');
      }

      if (myShip === undefined) {
        throw new Error('Ship assignment not received');
      }

      addTestLog('‚úÖ Socket connected, Player ID assigned', 'test-pass');
      return true;
    }
    
    // Test 2: Basic combat math
    async function testCombatMathBasic() {
      addTestLog('Test 2: Combat Math (Basic Attack)', 'test');
      
      return new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          reject(new Error('Combat response timeout'));
        }, 5000);
        
        socket.once('combatResult', (data) => {
          clearTimeout(timeout);
          
          const { result } = data;
          
          // Verify required fields exist
          if (!result.attackRoll || !result.attackTotal || result.hit === undefined) {
            reject(new Error('Missing combat result fields'));
            return;
          }
          
          // Verify attack total calculation
          const expectedTotal = result.attackRoll.total + result.skill + result.rangeDM - result.dodgeDM;
          if (result.attackTotal !== expectedTotal) {
            reject(new Error(`Attack math incorrect: ${result.attackTotal} !== ${expectedTotal}`));
            return;
          }
          
          addTestLog('‚úÖ Combat math correct', 'test-pass', `Roll: ${result.attackRoll.total}, Total: ${result.attackTotal}`);
          resolve(true);
        });
        
        socket.emit('combat', {
          attacker: 'scout',
          target: 'corsair',
          range: 'medium',
          dodge: 'none',
          seed: Date.now()
        });
      });
    }
    
    // Test 3: Verify hits work correctly
    async function testCombatMathHit() {
      addTestLog('Test 3: Hit Detection (Adjacent + No Dodge)', 'test');
      
      return new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          reject(new Error('Combat response timeout'));
        }, 5000);
        
        socket.once('combatResult', (data) => {
          clearTimeout(timeout);
          
          const { result } = data;
          
          // Adjacent (+2) + Scout skill (+2) should often hit (need 4+ on 2d6)
          // We can't guarantee hit, but we can verify damage logic IF hit
          if (result.hit) {
            if (!result.damageRoll || result.damage === undefined) {
              reject(new Error('Hit but missing damage data'));
              return;
            }
            
            const expectedDamage = Math.max(0, result.damageRoll.total - result.armor);
            if (result.damage !== expectedDamage) {
              reject(new Error(`Damage calculation incorrect: ${result.damage} !== ${expectedDamage}`));
              return;
            }
          }
          
          addTestLog('‚úÖ Hit detection and damage math correct', 'test-pass', result.hit ? `Damage: ${result.damage}` : 'Missed (OK)');
          resolve(true);
        });
        
        socket.emit('combat', {
          attacker: 'scout',
          target: 'corsair',
          range: 'adjacent', // +2 bonus
          dodge: 'none',
          seed: Date.now()
        });
      });
    }
    
    // Test 4: Verify misses work correctly
    async function testCombatMathMiss() {
      addTestLog('Test 4: Miss Detection (Very Long + Full Dodge)', 'test');
      
      return new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          reject(new Error('Combat response timeout'));
        }, 5000);
        
        socket.once('combatResult', (data) => {
          clearTimeout(timeout);
          
          const { result } = data;
          
          // Very Long (-4) + Full Dodge (-2) = -6 penalty
          // Scout skill +2, so need 12+ on 2d6 to hit (impossible)
          // But dice are random, so we just verify if miss, no damage dealt
          if (!result.hit) {
            if (result.damage !== undefined && result.damage > 0) {
              reject(new Error('Miss but damage > 0'));
              return;
            }
          }
          
          addTestLog('‚úÖ Miss detection correct', 'test-pass', `Total: ${result.attackTotal} vs 8`);
          resolve(true);
        });
        
        socket.emit('combat', {
          attacker: 'scout',
          target: 'corsair',
          range: 'veryLong', // -4 penalty
          dodge: 'full', // -2 penalty
          seed: Date.now()
        });
      });
    }
    
    // Test 5: Range modifiers
    async function testRangeModifiers() {
      addTestLog('Test 5: Range Modifier Application', 'test');
      
      return new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          reject(new Error('Combat response timeout'));
        }, 5000);
        
        socket.once('combatResult', (data) => {
          clearTimeout(timeout);
          
          const { result } = data;
          
          // Verify long range gives -2 DM
          if (result.rangeDM !== -2) {
            reject(new Error(`Range DM incorrect: ${result.rangeDM} !== -2`));
            return;
          }
          
          addTestLog('‚úÖ Range modifiers applied correctly', 'test-pass', 'Long range: -2 DM');
          resolve(true);
        });
        
        socket.emit('combat', {
          attacker: 'scout',
          target: 'corsair',
          range: 'long',
          dodge: 'none',
          seed: Date.now()
        });
      });
    }
    
    // Test 6: Dodge modifiers
    async function testDodgeModifiers() {
      addTestLog('Test 6: Dodge Modifier Application', 'test');
      
      return new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          reject(new Error('Combat response timeout'));
        }, 5000);
        
        socket.once('combatResult', (data) => {
          clearTimeout(timeout);
          
          const { result } = data;
          
          // Verify partial dodge gives -1 DM
          if (result.dodgeDM !== -1) {
            reject(new Error(`Dodge DM incorrect: ${result.dodgeDM} !== -1`));
            return;
          }
          
          addTestLog('‚úÖ Dodge modifiers applied correctly', 'test-pass', 'Partial dodge: -1 DM');
          resolve(true);
        });
        
        socket.emit('combat', {
          attacker: 'scout',
          target: 'corsair',
          range: 'medium',
          dodge: 'partial',
          seed: Date.now()
        });
      });
    }
    
    // Test 7: Multi-tab synchronization
    async function testMultiTabSync() {
      addTestLog('Test 7: Multi-Tab Synchronization', 'test');
      
      // This test just verifies that combat results are broadcast
      // In a real scenario, you'd open another tab to verify
      // For now, we just check that the socket emits to all
      
      addTestLog('‚úÖ Multi-tab sync ready (open 2nd tab to verify)', 'test-pass', 'Socket.io broadcast enabled');
      return true;
    }
    
    function addTestLog(message, type = 'test', details = '') {
      const entry = document.createElement('div');
      entry.className = 'log-entry ' + type;
      
      let html = `<div class="log-header">${message}</div>`;
      if (details) {
        html += `<div class="log-details">${details}</div>`;
      }
      
      entry.innerHTML = html;
      combatLog.appendChild(entry);
      combatLog.scrollTop = combatLog.scrollHeight;
    }
    
    function displayCombatResult(data) {
      const { result, breakdown } = data;

      const entry = document.createElement('div');
      entry.className = 'log-entry ' + (result.hit ? 'hit' : 'miss');

      let html = `<div class="log-header">`;
      html += `<span class="badge ${result.hit ? 'hit' : 'miss'}">${result.hit ? 'HIT' : 'MISS'}</span>`;
      html += `${result.attacker} attacks ${result.target}`;
      // Stage 5: Show weapon name
      if (result.weapon) {
        html += ` with ${result.weapon}`;
      }
      html += `</div>`;

      html += `<div class="log-details">`;
      html += `<div class="stat-line">Roll: [${result.attackRoll.dice.join(', ')}] = ${result.attackRoll.total}</div>`;
      html += `<div class="stat-line">Skill: +${result.skill} | Range: ${result.rangeDM >= 0 ? '+' : ''}${result.rangeDM} | Dodge: -${result.dodgeDM}</div>`;
      html += `<div class="stat-line">Total: ${result.attackTotal} vs target 8</div>`;

      if (result.hit) {
        html += `<div class="stat-line" style="margin-top: 8px;">Damage: [${result.damageRoll.dice.join(', ')}] = ${result.damageRoll.total} - ${result.armor} (armor) = ${result.damage}</div>`;
        html += `<div class="stat-line">Hull: ${result.target} now at ${result.newHull} hull points</div>`;
      }

      html += `</div>`;

      entry.innerHTML = html;
      combatLog.appendChild(entry);
      combatLog.scrollTop = combatLog.scrollHeight;
    }
    
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    console.log('========================================');
    console.log('TRAVELLER COMBAT VTT - STAGE 4');
    console.log('========================================');
    console.log('Turn-based combat system loaded');
    console.log('1. Wait for both players to connect');
    console.log('2. Click "Start Game" to begin Round 1');
    console.log('3. Take turns attacking (initiative determines order)');
    console.log('4. Click "End Turn" to pass to opponent');
    console.log('Click "Run Tests" button to verify functionality');
    console.log('========================================');

    // ======== STAGE 8.6: SHIP SELECTION UI ========

    const shipSelectionScreen = document.getElementById('ship-selection-screen');
    const personalCombatScreen = document.getElementById('personal-combat-screen');
    const readyButton = document.getElementById('ready-button');
    const playerReadyIndicator = document.getElementById('player-ready-indicator');
    const opponentReadyIndicator = document.getElementById('opponent-ready-indicator');
    const readyStatusText = document.getElementById('ready-status');
    const rangeSelect = document.getElementById('range-select');

    let selectedShip = null;
    let selectedRange = 'Short';
    let playerReady = false;
    let opponentReady = false;

    // Ship selection handlers
    document.querySelectorAll('.ship-option').forEach(option => {
      option.addEventListener('click', function() {
        // Remove selection from all options
        document.querySelectorAll('.ship-option').forEach(opt => {
          opt.classList.remove('selected');
        });

        // Select this option
        this.classList.add('selected');
        selectedShip = this.dataset.ship;

        console.log(`[SHIP SELECTION] Selected ${selectedShip}`);

        // Emit ship selection to server
        socket.emit('space:shipSelected', { ship: selectedShip });

        // Update ready button state
        updateReadyButton();
      });
    });

    // Range selection handler
    rangeSelect.addEventListener('change', function() {
      selectedRange = this.value;
      console.log(`[RANGE SELECTION] Selected ${selectedRange}`);

      // Emit range selection to server
      socket.emit('space:rangeSelected', { range: selectedRange });

      // Update ready button state
      updateReadyButton();
    });

    // Ready button handler
    readyButton.addEventListener('click', function() {
      if (!selectedShip || !selectedRange) {
        alert('Please select a ship and starting range!');
        return;
      }

      playerReady = true;
      readyButton.disabled = true;
      readyButton.innerHTML = 'Waiting...';

      console.log(`[READY] Player ready with ${selectedShip} at ${selectedRange} range`);

      // Emit ready status to server
      socket.emit('space:playerReady', {
        ship: selectedShip,
        range: selectedRange
      });

      // Update UI
      playerReadyIndicator.className = 'ready-indicator ready';
      playerReadyIndicator.innerHTML = '‚úì Ready';
      readyStatusText.innerHTML = 'Waiting for opponent...';
    });

    // Update ready button state
    function updateReadyButton() {
      if (selectedShip && selectedRange && !playerReady) {
        readyButton.disabled = false;
      } else {
        readyButton.disabled = true;
      }
    }

    // Listen for opponent ready status
    socket.on('space:opponentReady', (data) => {
      console.log('[OPPONENT READY]', data);
      opponentReady = true;
      opponentReadyIndicator.className = 'ready-indicator ready';
      opponentReadyIndicator.innerHTML = '‚úì Ready';

      // Check if both players are ready
      if (playerReady && opponentReady) {
        readyStatusText.innerHTML = 'Starting combat...';
      }
    });

    // Listen for combat start
    socket.on('space:combatStart', (data) => {
      console.log('[COMBAT START]', data);

      // Hide ship selection, show space combat HUD
      shipSelectionScreen.style.display = 'none';
      spaceCombatHUD.style.display = 'block';

      // Initialize HUD with ship data
      initializeSpaceCombatHUD(data);

      readyStatusText.innerHTML = 'Combat started!';
    });

    // Initialize range selection
    selectedRange = rangeSelect.value;

    console.log('========================================');
    console.log('TRAVELLER COMBAT VTT - STAGE 8.6');
    console.log('========================================');
    console.log('Space Combat Ship Selection loaded');
    console.log('1. Select your spacecraft (Scout or Free Trader)');
    console.log('2. Choose starting range (Adjacent to Distant)');
    console.log('3. Click "Ready" when ready to fight');
    console.log('4. Combat starts when both players ready');
    console.log('========================================');

    // ======== STAGE 8.7: SPACE COMBAT HUD ========

    const spaceCombatHUD = document.getElementById('space-combat-hud');
    const crewPanelToggle = document.getElementById('crew-panel-toggle');
    const crewPanelContent = document.getElementById('crew-panel-content');
    const fireButton = document.getElementById('fire-button');
    const turretSelect = document.getElementById('turret-select');
    const targetSelect = document.getElementById('target-select');
    const weaponSelect = document.getElementById('weapon-select');
    const useDefaultButton = document.getElementById('use-default-button');
    const endTurnButton = document.getElementById('end-turn-button');
    const combatLog = document.getElementById('combat-log');
    const turnTimer = document.getElementById('turn-timer');

    let currentShipData = null;
    let turnTimeRemaining = 30;
    let turnTimerInterval = null;

    // Initialize Space Combat HUD with ship data
    function initializeSpaceCombatHUD(data) {
      console.log('[HUD] Initializing with data:', data);

      // Store combat data
      currentShipData = {
        ship: selectedShip,
        range: data.range || selectedRange,
        round: 1,
        hull: selectedShip === 'scout' ? 20 : 30,
        maxHull: selectedShip === 'scout' ? 20 : 30,
        armour: selectedShip === 'scout' ? 4 : 2,
        turrets: selectedShip === 'scout' ? 1 : 2
      };

      // Update HUD display
      updateShipHUD();

      // Update combat log
      addLogEntry(`Combat started at ${data.range} range`, 'system');
      addLogEntry(`Round ${currentShipData.round} begins!`, 'system');

      // Start turn timer
      startTurnTimer();
    }

    // Update ship HUD display
    function updateShipHUD() {
      if (!currentShipData) return;

      // Ship name and type
      const shipNameEl = document.getElementById('ship-name');
      const shipTypeEl = shipNameEl.nextElementSibling;

      if (currentShipData.ship === 'scout') {
        shipNameEl.textContent = '‚ö° Scout';
        shipTypeEl.textContent = 'Type-S Scout/Courier';
      } else {
        shipNameEl.textContent = 'üì¶ Free Trader';
        shipTypeEl.textContent = 'Type-A Free Trader';
      }

      // Hull bar
      document.getElementById('hull-current').textContent = currentShipData.hull;
      document.getElementById('hull-max').textContent = currentShipData.maxHull;

      const hullPercent = (currentShipData.hull / currentShipData.maxHull) * 100;
      const hullFill = document.getElementById('hull-bar-fill');
      hullFill.style.width = `${hullPercent}%`;

      // Update hull bar color based on damage
      hullFill.classList.remove('damaged', 'critical');
      if (hullPercent <= 25) {
        hullFill.classList.add('critical');
      } else if (hullPercent <= 50) {
        hullFill.classList.add('damaged');
      }

      // Other stats
      document.getElementById('ship-armour').textContent = currentShipData.armour;
      document.getElementById('current-range').textContent = currentShipData.range;
      document.getElementById('round-counter').textContent = currentShipData.round;

      // Initiative (placeholder for now)
      document.getElementById('initiative-value').textContent = 'Your turn';
    }

    // Crew panel collapse/expand
    crewPanelToggle.addEventListener('click', () => {
      crewPanelContent.classList.toggle('collapsed');
      crewPanelToggle.classList.toggle('collapsed');
    });

    // Fire button enable/disable based on selections
    function updateFireButtonState() {
      const turretSelected = turretSelect.value !== '';
      const targetSelected = targetSelect.value !== '';
      const weaponSelected = weaponSelect.value !== '';

      fireButton.disabled = !(turretSelected && targetSelected && weaponSelected);
    }

    turretSelect.addEventListener('change', updateFireButtonState);
    targetSelect.addEventListener('change', updateFireButtonState);
    weaponSelect.addEventListener('change', updateFireButtonState);

    // Fire button handler
    fireButton.addEventListener('click', () => {
      console.log('[FIRE] Button clicked');

      const action = {
        turret: parseInt(turretSelect.value),
        target: targetSelect.value,
        weapon: parseInt(weaponSelect.value)
      };

      addLogEntry(`Firing turret ${action.turret + 1} at ${action.target}...`, 'system');

      // Emit fire action to server
      socket.emit('space:fire', action);

      // Disable fire button until next turn
      fireButton.disabled = true;
    });

    // Use Default button
    useDefaultButton.addEventListener('click', () => {
      console.log('[USE DEFAULT] Button clicked');

      // Auto-select first options
      turretSelect.value = '0';
      targetSelect.value = 'opponent';
      weaponSelect.value = '0';

      updateFireButtonState();
      addLogEntry('Using default action (auto-fire)', 'system');

      // Auto-fire
      fireButton.click();
    });

    // End Turn button
    endTurnButton.addEventListener('click', () => {
      console.log('[END TURN] Button clicked');

      addLogEntry('Turn ended', 'system');

      // Emit end turn to server
      socket.emit('space:endTurn');

      // Disable buttons
      fireButton.disabled = true;
      endTurnButton.disabled = true;
      useDefaultButton.disabled = true;

      // Reset turn timer
      stopTurnTimer();
    });

    // Turn timer functions
    function startTurnTimer() {
      turnTimeRemaining = 30;
      updateTimerDisplay();

      if (turnTimerInterval) {
        clearInterval(turnTimerInterval);
      }

      turnTimerInterval = setInterval(() => {
        turnTimeRemaining--;
        updateTimerDisplay();

        if (turnTimeRemaining <= 0) {
          stopTurnTimer();
          // Auto-end turn
          useDefaultButton.click();
        }
      }, 1000);
    }

    function stopTurnTimer() {
      if (turnTimerInterval) {
        clearInterval(turnTimerInterval);
        turnTimerInterval = null;
      }
    }

    function updateTimerDisplay() {
      turnTimer.textContent = `${turnTimeRemaining}s`;

      // Update timer color
      turnTimer.classList.remove('warning', 'critical');
      if (turnTimeRemaining <= 5) {
        turnTimer.classList.add('critical');
      } else if (turnTimeRemaining <= 10) {
        turnTimer.classList.add('warning');
      }
    }

    // Add entry to combat log
    function addLogEntry(message, type = '') {
      const entry = document.createElement('div');
      entry.className = 'log-entry' + (type ? ' ' + type : '');
      entry.textContent = message;
      combatLog.appendChild(entry);

      // Auto-scroll to bottom
      combatLog.scrollTop = combatLog.scrollHeight;
    }

    // Listen for combat events from server (Stage 8.8)
    socket.on('space:attackResult', (data) => {
      console.log('[ATTACK RESULT]', data);

      if (data.hit) {
        addLogEntry(`HIT! ${data.damage} damage dealt (Roll: ${data.attackRoll}, Total: ${data.total})`, 'hit');
      } else {
        addLogEntry(`MISS! (Roll: ${data.attackRoll}, Total: ${data.total}, Need: ${data.targetNumber})`, 'miss');
      }
    });

    socket.on('space:attacked', (data) => {
      console.log('[ATTACKED]', data);

      if (data.hit) {
        addLogEntry(`Enemy hits! ${data.damage} damage taken!`, 'hit');
        currentShipData.hull = data.hull;
        updateShipHUD();
      } else {
        addLogEntry('Enemy misses!', 'miss');
      }
    });

    socket.on('space:critical', (data) => {
      console.log('[CRITICAL]', data);
      addLogEntry(`CRITICAL HIT! ${data.system} system damaged!`, 'critical');
    });

    socket.on('space:newRound', (data) => {
      console.log('[NEW ROUND]', data);

      currentShipData.round = data.round;
      updateShipHUD();
      addLogEntry(`Round ${data.round} begins!`, 'system');

      // Re-enable buttons
      updateFireButtonState();
      endTurnButton.disabled = false;
      useDefaultButton.disabled = false;

      // Restart turn timer
      startTurnTimer();
    });

    socket.on('space:turnChange', (data) => {
      console.log('[TURN CHANGE]', data);

      const isMyTurn = data.activePlayer === socket.id;
      if (isMyTurn) {
        addLogEntry('Your turn!', 'system');
        updateFireButtonState();
        endTurnButton.disabled = false;
        useDefaultButton.disabled = false;
        startTurnTimer();
      } else {
        addLogEntry('Opponent\'s turn...', 'system');
        fireButton.disabled = true;
        endTurnButton.disabled = true;
        useDefaultButton.disabled = true;
        stopTurnTimer();
      }
    });

    socket.on('space:combatEnd', (data) => {
      console.log('[COMBAT END]', data);

      stopTurnTimer();

      const isWinner = (data.winner === 'player1' && currentShipData.ship === selectedShip);

      if (isWinner) {
        addLogEntry(`üéâ VICTORY! Enemy ship destroyed in ${data.rounds} rounds!`, 'system');
      } else {
        addLogEntry(`üí• DEFEAT! Your ship was destroyed in ${data.rounds} rounds.`, 'system');
      }

      // Disable all combat buttons
      fireButton.disabled = true;
      endTurnButton.disabled = true;
      useDefaultButton.disabled = true;

      // Show victory/defeat message
      setTimeout(() => {
        alert(isWinner ? `VICTORY!\n\nEnemy destroyed in ${data.rounds} rounds!\n\nYour Hull: ${currentShipData.hull}/${currentShipData.maxHull}`
                        : `DEFEAT!\n\nYour ship was destroyed in ${data.rounds} rounds.`);
      }, 500);
    });

    socket.on('space:notYourTurn', (data) => {
      console.log('[NOT YOUR TURN]', data);
      addLogEntry(data.message, 'system');
    });

    console.log('========================================');
    console.log('TRAVELLER COMBAT VTT - STAGE 8.7');
    console.log('========================================');
    console.log('Space Combat HUD loaded');
    console.log('========================================');
  </script>
  </div> <!-- Close personal-combat-screen -->
</body>
</html>
